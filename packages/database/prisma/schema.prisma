generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model School {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  email               String               @unique
  phone               String?
  address             String?
  logo                String?
  website             String?
  subscriptionTier    SubscriptionTier     @default(FREE_TRIAL_1M)
  subscriptionStart   DateTime             @default(now())
  subscriptionEnd     DateTime?
  isActive            Boolean              @default(true)
  isTrial             Boolean              @default(true)
  maxStudents         Int                  @default(100)
  maxTeachers         Int                  @default(10)
  maxStorage          BigInt               @default(1073741824)
  currentStudents     Int                  @default(0)
  currentTeachers     Int                  @default(0)
  currentStorage      BigInt               @default(0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  gradeRange          String               @default("7-12")
  onboardingStep      Int                  @default(0)
  schoolType          SchoolType           @default(HIGH_SCHOOL)
  setupCompleted      Boolean              @default(false)
  setupCompletedAt    DateTime?
  workingDays         Int[]                @default([1, 2, 3, 4, 5])
  academicYears       AcademicYear[]
  classes             Class[]
  onboardingChecklist OnboardingChecklist?
  periods             Period[]
  schoolSettings      SchoolSettings?
  schoolShifts        SchoolShift[]
  students            Student[]
  teachers            Teacher[]
  timetableEntries    TimetableEntry[]
  users               User[]

  @@index([slug])
  @@index([subscriptionTier])
  @@index([isActive])
  @@map("schools")
}

model AcademicYear {
  id               String               @id @default(cuid())
  schoolId         String
  name             String
  startDate        DateTime
  endDate          DateTime
  isCurrent        Boolean              @default(false)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  copiedFromYearId String?
  isPromotionDone  Boolean              @default(false)
  promotionDate    DateTime?
  status           AcademicYearStatus   @default(PLANNING)
  calendars        AcademicCalendar[]
  terms            AcademicTerm[]
  copiedFromYear   AcademicYear?        @relation("YearCopy", fields: [copiedFromYearId], references: [id])
  copiedToYears    AcademicYear[]       @relation("YearCopy")
  school           School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes          Class[]
  examTypes        ExamType[]
  gradingScales    GradingScale[]
  progressionsFrom StudentProgression[] @relation("FromYear")
  progressionsTo   StudentProgression[] @relation("ToYear")
  timetableEntries TimetableEntry[]

  @@unique([schoolId, name])
  @@index([schoolId, isCurrent])
  @@index([schoolId, status])
  @@map("academic_years")
}

model StudentProgression {
  id                 String        @id @default(cuid())
  studentId          String
  fromAcademicYearId String
  toAcademicYearId   String
  fromClassId        String
  toClassId          String
  promotionType      PromotionType
  promotionDate      DateTime
  promotedBy         String
  notes              String?
  createdAt          DateTime      @default(now())
  fromAcademicYear   AcademicYear  @relation("FromYear", fields: [fromAcademicYearId], references: [id])
  fromClass          Class         @relation("FromClass", fields: [fromClassId], references: [id])
  student            Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  toAcademicYear     AcademicYear  @relation("ToYear", fields: [toAcademicYearId], references: [id])
  toClass            Class         @relation("ToClass", fields: [toClassId], references: [id])

  @@unique([studentId, fromAcademicYearId, toAcademicYearId])
  @@index([studentId])
  @@index([fromAcademicYearId])
  @@index([toAcademicYearId])
  @@map("student_progressions")
}

model Attendance {
  id        String            @id @default(cuid())
  studentId String
  classId   String?
  date      DateTime
  status    AttendanceStatus
  remarks   String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  session   AttendanceSession @default(MORNING)
  class     Class?            @relation(fields: [classId], references: [id])
  student   Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, date, session])
  @@index([classId, date])
  @@index([studentId, date])
  @@index([date, status])
  @@map("attendance")
}

model Class {
  id                      String                  @id @default(cuid())
  schoolId                String
  classId                 String?                 @unique
  name                    String
  grade                   String
  section                 String?
  capacity                Int?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  track                   String?
  homeroomTeacherId       String?                 @unique
  academicYearId          String
  attendance              Attendance[]
  classShiftOverrides     ClassShiftOverride[]
  classShift              ClassShift?
  academicYear            AcademicYear            @relation(fields: [academicYearId], references: [id])
  school                  School                  @relation(fields: [schoolId], references: [id])
  grades                  Grade[]
  studentClasses          StudentClass[]
  studentMonthlySummaries StudentMonthlySummary[]
  progressionsFrom        StudentProgression[]    @relation("FromClass")
  progressionsTo          StudentProgression[]    @relation("ToClass")
  students                Student[]
  teacherClasses          TeacherClass[]
  homeroomTeacher         Teacher?
  timetableEntries        TimetableEntry[]

  @@index([schoolId])
  @@index([grade])
  @@index([schoolId, grade])
  @@index([academicYearId])
  @@index([schoolId, academicYearId])
  @@map("classes")
}

model Grade {
  id            String   @id @default(cuid())
  studentId     String
  subjectId     String
  classId       String
  score         Float
  maxScore      Float
  month         String?
  monthNumber   Int?
  year          Int?
  percentage    Float?
  weightedScore Float?
  remarks       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  class         Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject       Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([studentId, subjectId, classId, month, year])
  @@index([classId, month, year])
  @@index([studentId, month, year])
  @@index([subjectId, classId])
  @@map("grades")
}

model GradeConfirmation {
  id          String   @id @default(cuid())
  classId     String
  subjectId   String
  month       String
  year        Int
  isConfirmed Boolean  @default(false)
  confirmedBy String
  confirmedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [confirmedBy], references: [id], onDelete: Cascade)

  @@unique([classId, subjectId, month, year])
  @@index([classId, month, year])
  @@index([confirmedBy])
  @@map("grade_confirmations")
}

model StudentMonthlySummary {
  id                 String   @id @default(cuid())
  studentId          String
  classId            String
  month              String
  monthNumber        Int
  year               Int
  totalScore         Float
  totalMaxScore      Float
  totalWeightedScore Float
  totalCoefficient   Float
  average            Float
  classRank          Int?
  gradeLevel         String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  class              Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student            Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, month, year])
  @@index([classId, month, year])
  @@index([studentId, year])
  @@index([month, year, average])
  @@map("student_monthly_summaries")
}

model Student {
  id                   String                  @id @default(cuid())
  schoolId             String
  studentId            String?                 @unique
  firstName            String
  lastName             String
  khmerName            String
  dateOfBirth          String
  gender               Gender
  englishName          String?
  email                String?                 @unique
  placeOfBirth         String?                 @default("ភ្នំពេញ")
  currentAddress       String?                 @default("ភ្នំពេញ")
  phoneNumber          String?
  classId              String?
  fatherName           String?                 @default("ឪពុក")
  motherName           String?                 @default("ម្តាយ")
  parentPhone          String?
  parentOccupation     String?                 @default("កសិករ")
  previousGrade        String?
  remarks              String?
  photoUrl             String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  grade12ExamCenter    String?
  grade12ExamDesk      String?
  grade12ExamRoom      String?
  grade12ExamSession   String?
  grade12PassStatus    String?
  grade12Track         String?
  grade9ExamCenter     String?
  grade9ExamDesk       String?
  grade9ExamRoom       String?
  grade9ExamSession    String?
  grade9PassStatus     String?
  previousSchool       String?
  repeatingGrade       String?
  transferredFrom      String?
  accountDeactivatedAt DateTime?
  deactivationReason   String?
  isAccountActive      Boolean                 @default(true)
  studentRole          StudentRole             @default(GENERAL)
  attendance           Attendance[]
  grades               Grade[]
  studentClasses       StudentClass[]
  monthlySummaries     StudentMonthlySummary[]
  studentParents       StudentParent[]
  StudentProgression   StudentProgression[]
  class                Class?                  @relation(fields: [classId], references: [id])
  school               School                  @relation(fields: [schoolId], references: [id])
  user                 User?
  conversations        Conversation[]

  @@index([schoolId])
  @@index([classId])
  @@index([grade12PassStatus])
  @@index([gender])
  @@index([isAccountActive])
  @@index([classId, studentRole])
  @@index([schoolId, classId])
  @@index([schoolId, isAccountActive])
  @@index([schoolId, firstName, lastName])
  @@index([schoolId, createdAt])
  @@map("students")
}

model Parent {
  id              String             @id @default(cuid())
  parentId        String?            @unique
  firstName       String
  lastName        String
  khmerName       String
  englishName     String?
  gender          Gender?
  email           String?            @unique
  phone           String             @unique
  address         String?
  relationship    ParentRelationship
  occupation      String?            @default("កសិករ")
  emergencyPhone  String?
  isAccountActive Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  studentParents  StudentParent[]
  user            User?
  conversations   Conversation[]

  @@index([phone, isAccountActive])
  @@index([email, isAccountActive])
  @@map("parents")
}

model StudentParent {
  id           String             @id @default(cuid())
  studentId    String
  parentId     String
  isPrimary    Boolean            @default(false)
  relationship ParentRelationship
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  parent       Parent             @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student      Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId])
  @@index([studentId])
  @@index([parentId])
  @@map("student_parents")
}

model StudentClass {
  id             String   @id @default(cuid())
  studentId      String
  classId        String
  academicYearId String?
  enrolledAt     DateTime @default(now())
  status         String   @default("ACTIVE")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  class          Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student        Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, academicYearId])
  @@index([studentId])
  @@index([classId])
  @@index([status])
  @@map("student_classes")
}

model SubjectTeacher {
  id        String   @id @default(cuid())
  subjectId String
  teacherId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([subjectId, teacherId])
  @@map("subject_teachers")
}

model Subject {
  id                        String                     @id @default(cuid())
  name                      String
  nameKh                    String
  nameEn                    String?
  code                      String                     @unique
  description               String?
  grade                     String
  track                     String?
  category                  String
  weeklyHours               Float                      @default(0)
  annualHours               Int                        @default(0)
  maxScore                  Int                        @default(100)
  coefficient               Float                      @default(1.0)
  isActive                  Boolean                    @default(true)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  grades                    Grade[]
  subjectTeachers           SubjectTeacher[]
  teacherSubjectAssignments TeacherSubjectAssignment[] @relation("TeacherSubjectAssignments")
  timetableEntries          TimetableEntry[]

  @@index([grade, isActive])
  @@index([grade, track, isActive])
  @@map("subjects")
}

model TeacherClass {
  id        String   @id @default(cuid())
  teacherId String
  classId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, classId])
  @@map("teacher_classes")
}

model Teacher {
  id                        String                     @id @default(cuid())
  schoolId                  String
  teacherId                 String?                    @unique
  firstName                 String
  lastName                  String
  khmerName                 String?
  email                     String?                    @unique
  phone                     String                     @unique
  employeeId                String?                    @unique
  gender                    Gender?
  dateOfBirth               String?
  position                  String?
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  address                   String?
  hireDate                  String?
  homeroomClassId           String?                    @unique
  role                      TeacherRole                @default(TEACHER)
  englishName               String?
  degree                    DegreeLevel?
  emergencyContact          String?
  emergencyPhone            String?
  idCard                    String?
  major1                    String?
  major2                    String?
  nationality               String?
  passport                  String?
  phoneNumber               String?
  salaryRange               String?
  workingLevel              WorkingLevel?
  photoUrl                  String?
  subjectTeachers           SubjectTeacher[]
  teacherClasses            TeacherClass[]
  teacherSubjectAssignments TeacherSubjectAssignment[]
  homeroomClass             Class?                     @relation(fields: [homeroomClassId], references: [id])
  school                    School                     @relation(fields: [schoolId], references: [id])
  timetableEntries          TimetableEntry[]
  user                      User?
  conversations             Conversation[]

  @@index([schoolId])
  @@index([schoolId, position])
  @@index([schoolId, createdAt])
  @@index([email])
  @@map("teachers")
}

model User {
  id                    String              @id @default(cuid())
  schoolId              String?
  email                 String?             @unique
  password              String
  firstName             String
  lastName              String
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  failedAttempts        Int                 @default(0)
  isActive              Boolean             @default(true)
  lastLogin             DateTime?
  lockedUntil           DateTime?
  loginCount            Int                 @default(0)
  permissions           Json?               @default("{\"canEnterGrades\": true, \"canViewReports\": true, \"canMarkAttendance\": true}")
  phone                 String?             @unique
  studentId             String?             @unique
  teacherId             String?             @unique
  role                  UserRole            @default(TEACHER)
  accountSuspendedAt    DateTime?
  isDefaultPassword     Boolean             @default(true)
  isSuperAdmin          Boolean             @default(false)
  lastPasswordHashes    String[]
  passwordChangedAt     DateTime?
  passwordExpiresAt     DateTime?
  passwordResetExpiry   DateTime?
  passwordResetToken    String?             @unique
  suspensionReason      String?
  parentId              String?             @unique
  profilePictureUrl     String?
  profilePictureKey     String?
  coverPhotoUrl         String?
  coverPhotoKey         String?
  bio                   String?
  headline              String?
  interests             String[]
  skills                String[]
  socialLinks           Json?
  profileCompleteness   Int                 @default(0)
  profileUpdatedAt      DateTime?
  profileVisibility     ProfileVisibility   @default(SCHOOL)
  careerGoals           String?
  location              String?
  languages             String[]
  professionalTitle     String?
  isVerified            Boolean             @default(false)
  verifiedAt            DateTime?
  totalLearningHours    Int                 @default(0)
  currentStreak         Int                 @default(0)
  longestStreak         Int                 @default(0)
  totalPoints           Int                 @default(0)
  level                 Int                 @default(1)
  isOpenToOpportunities Boolean             @default(false)
  resumeUrl             String?
  resumeKey             String?
  achievements          Achievement[]
  adminAuditLogs        AuditLog[]          @relation("AuditLogAdmin")
  teacherAuditLogs      AuditLog[]          @relation("AuditLogTeacher")
  certifications        Certification[]
  commentReactions      CommentReaction[]
  comments              Comment[]
  education             Education[]
  experiences           Experience[]
  following             Follow[]            @relation("Following")
  followers             Follow[]            @relation("Followers")
  gradeConfirmations    GradeConfirmation[]
  likes                 Like[]
  bookmarks             Bookmark[]          @relation("UserBookmarks")
  sentNotifications     Notification[]      @relation("NotificationActor")
  notifications         Notification[]      @relation("NotificationRecipient")
  pollVotes             PollVote[]          @relation("PollVotes")
  reportedPosts         PostReport[]        @relation("PostReporter")
  reviewedReports       PostReport[]        @relation("ReportReviewer")
  postViews             PostView[]
  posts                 Post[]
  projects              Project[]
  givenRecommendations  Recommendation[]    @relation("RecommendationAuthor")
  recommendations       Recommendation[]    @relation("RecommendationRecipient")
  endorsementsGiven     SkillEndorsement[]  @relation("EndorsementGiver")
  endorsementsReceived  SkillEndorsement[]  @relation("EndorsementRecipient")
  blockedBy             UserBlock[]         @relation("Blocked")
  blocking              UserBlock[]         @relation("Blocker")
  userSkills            UserSkill[]
  dmParticipations      DMParticipant[]
  sentDirectMessages    DirectMessage[]     @relation("DMSender")
  dmReadReceipts        DMReadReceipt[]
  createdStudyClubs     StudyClub[]         @relation("ClubCreator")
  studyClubMemberships  StudyClubMember[]
  parent                Parent?             @relation(fields: [parentId], references: [id], onDelete: Cascade)
  school                School?             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student               Student?            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher               Teacher?            @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([email, isActive])
  @@index([phone, isActive])
  @@index([studentId, isActive])
  @@index([parentId, isActive])
  @@index([isDefaultPassword])
  @@index([passwordExpiresAt])
  @@index([schoolId])
  @@index([schoolId, role, isActive])
  @@index([schoolId, isActive])
  @@map("users")
}

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String
  teacherId String
  action    String
  reason    String?
  details   Json?
  createdAt DateTime @default(now())
  admin     User     @relation("AuditLogAdmin", fields: [adminId], references: [id])
  teacher   User     @relation("AuditLogTeacher", fields: [teacherId], references: [id])

  @@index([adminId])
  @@index([teacherId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Post {
  id                       String         @id @default(cuid())
  authorId                 String
  content                  String
  mediaUrls                String[]
  mediaKeys                String[]
  postType                 PostType       @default(ARTICLE)
  visibility               PostVisibility @default(SCHOOL)
  likesCount               Int            @default(0)
  commentsCount            Int            @default(0)
  sharesCount              Int            @default(0)
  isEdited                 Boolean        @default(false)
  isPinned                 Boolean        @default(false)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  pollExpiresAt            DateTime?
  pollAllowMultiple        Boolean        @default(false)
  pollMaxChoices           Int?
  pollIsAnonymous          Boolean        @default(false)
  assignmentDueDate        DateTime?
  assignmentPoints         Int?
  assignmentSubmissionType String?
  courseCode               String?
  courseLevel              String?
  courseDuration           String?
  announcementUrgency      String?
  announcementExpiryDate   DateTime?
  tutorialDifficulty       String?
  tutorialEstimatedTime    String?
  tutorialPrerequisites    String?
  examDate                 DateTime?
  examDuration             Int?
  examTotalPoints          Int?
  examPassingScore         Int?
  resourceType             String?
  resourceUrl              String?
  researchField            String?
  researchCollaborators    String?
  projectStatus            String?
  projectDeadline          DateTime?
  projectTeamSize          Int?
  mediaDisplayMode         String?        @default("AUTO") // AUTO, FIXED_HEIGHT, FULL_HEIGHT
  studyClubId              String? // If posted in a study club
  comments                 Comment[]
  likes                    Like[]
  bookmarks                Bookmark[]
  pollOptions              PollOption[]
  views                    PostView[]
  author                   User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  quizQuestions            QuizQuestion[]
  studyClub                StudyClub?     @relation("ClubPosts", fields: [studyClubId], references: [id], onDelete: SetNull)

  @@index([authorId, createdAt(sort: Desc)])
  @@index([postType, createdAt(sort: Desc)])
  @@index([visibility, createdAt(sort: Desc)])
  @@index([pollExpiresAt])
  @@index([studyClubId])
  @@map("posts")
}

model Comment {
  id        String            @id @default(cuid())
  postId    String
  authorId  String
  content   String
  parentId  String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  reactions CommentReaction[]
  author    User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent    Comment?          @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]         @relation("CommentReplies")
  post      Post              @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt(sort: Desc)])
  @@index([authorId])
  @@index([parentId])
  @@map("comments")
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
  @@map("likes")
}

model Bookmark {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation("UserBookmarks", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
  @@map("bookmarks")
}

model PollOption {
  id         String     @id @default(cuid())
  postId     String
  text       String
  position   Int        @default(0)
  votesCount Int        @default(0)
  createdAt  DateTime   @default(now())
  post       Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  votes      PollVote[]

  @@index([postId])
  @@map("poll_options")
}

model QuizQuestion {
  id            String   @id @default(cuid())
  postId        String
  question      String
  options       String[]
  correctAnswer Int
  points        Int      @default(10)
  position      Int      @default(0)
  explanation   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  post          Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("quiz_questions")
}

model PollVote {
  id        String     @id @default(cuid())
  postId    String
  optionId  String
  userId    String
  createdAt DateTime   @default(now())
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  user      User       @relation("PollVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, optionId, userId])
  @@index([userId])
  @@index([postId, userId])
  @@map("poll_votes")
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followingId])
  @@index([followerId])
  @@map("follows")
}

model Notification {
  id          String           @id @default(cuid())
  recipientId String
  actorId     String?
  type        NotificationType
  title       String
  message     String
  link        String?
  postId      String?
  commentId   String?
  isRead      Boolean          @default(false)
  readAt      DateTime?
  createdAt   DateTime         @default(now())
  actor       User?            @relation("NotificationActor", fields: [actorId], references: [id])
  recipient   User             @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId, isRead, createdAt(sort: Desc)])
  @@index([actorId])
  @@map("notifications")
}

model UserSkill {
  id           String             @id @default(cuid())
  userId       String
  skillName    String
  category     SkillCategory
  level        SkillLevel         @default(BEGINNER)
  yearsOfExp   Float?
  isVerified   Boolean            @default(false)
  verifiedBy   String?
  verifiedAt   DateTime?
  description  String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  endorsements SkillEndorsement[]
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillName])
  @@index([userId, category])
  @@index([skillName])
  @@map("user_skills")
}

model SkillEndorsement {
  id          String    @id @default(cuid())
  skillId     String
  endorserId  String
  recipientId String
  comment     String?
  createdAt   DateTime  @default(now())
  endorser    User      @relation("EndorsementGiver", fields: [endorserId], references: [id], onDelete: Cascade)
  recipient   User      @relation("EndorsementRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  skill       UserSkill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([skillId, endorserId])
  @@index([recipientId])
  @@index([endorserId])
  @@map("skill_endorsements")
}

model Experience {
  id           String         @id @default(cuid())
  userId       String
  type         ExperienceType
  title        String
  organization String
  location     String?
  startDate    DateTime
  endDate      DateTime?
  isCurrent    Boolean        @default(false)
  description  String?
  achievements String[]
  skills       String[]
  mediaUrls    String[]
  mediaKeys    String[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startDate(sort: Desc)])
  @@index([type])
  @@map("experiences")
}

model Certification {
  id             String    @id @default(cuid())
  userId         String
  name           String
  issuingOrg     String
  issueDate      DateTime
  expiryDate     DateTime?
  credentialId   String?
  credentialUrl  String?
  certificateUrl String?
  certificateKey String?
  description    String?
  skills         String[]
  isVerified     Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, issueDate(sort: Desc)])
  @@map("certifications")
}

model Education {
  id           String    @id @default(cuid())
  userId       String
  school       String
  degree       String?
  fieldOfStudy String?
  grade        String?
  startDate    DateTime
  endDate      DateTime?
  isCurrent    Boolean   @default(false)
  description  String?
  activities   String[]
  skills       String[]
  mediaUrls    String[]
  mediaKeys    String[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startDate(sort: Desc)])
  @@map("education")
}

model Project {
  id            String            @id @default(cuid())
  userId        String
  title         String
  description   String
  category      ProjectCategory
  status        ProjectStatus     @default(COMPLETED)
  startDate     DateTime?
  endDate       DateTime?
  role          String?
  teamSize      Int?
  technologies  String[]
  skills        String[]
  mediaUrls     String[]
  mediaKeys     String[]
  projectUrl    String?
  githubUrl     String?
  demoUrl       String?
  achievements  String[]
  collaborators String[]
  visibility    ProfileVisibility @default(PUBLIC)
  viewsCount    Int               @default(0)
  likesCount    Int               @default(0)
  isFeatured    Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([category, visibility])
  @@index([isFeatured])
  @@map("projects")
}

model Achievement {
  id             String            @id @default(cuid())
  userId         String
  type           AchievementType
  title          String
  description    String
  issuedBy       String?
  issuedDate     DateTime          @default(now())
  badgeUrl       String?
  badgeKey       String?
  certificateUrl String?
  certificateKey String?
  points         Int               @default(0)
  rarity         AchievementRarity @default(COMMON)
  isPublic       Boolean           @default(true)
  metadata       Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, issuedDate(sort: Desc)])
  @@index([type, rarity])
  @@map("achievements")
}

model Recommendation {
  id           String                 @id @default(cuid())
  recipientId  String
  authorId     String
  relationship RecommendationRelation
  content      String
  skills       String[]
  rating       Int?
  isPublic     Boolean                @default(true)
  isAccepted   Boolean                @default(false)
  acceptedAt   DateTime?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  author       User                   @relation("RecommendationAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  recipient    User                   @relation("RecommendationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([recipientId, authorId])
  @@index([recipientId, isAccepted])
  @@index([authorId])
  @@map("recommendations")
}

model CommentReaction {
  id        String       @id @default(cuid())
  commentId String
  userId    String
  type      ReactionType
  createdAt DateTime     @default(now())
  comment   Comment      @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId, type])
  @@index([commentId])
  @@index([userId])
  @@map("comment_reactions")
}

model PostReport {
  id         String       @id @default(cuid())
  postId     String
  reporterId String
  reason     ReportReason
  details    String?
  status     ReportStatus @default(PENDING)
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime     @default(now())
  reporter   User         @relation("PostReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reviewer   User?        @relation("ReportReviewer", fields: [reviewedBy], references: [id])

  @@index([postId, status])
  @@index([reporterId])
  @@index([status, createdAt])
  @@map("post_reports")
}

model UserBlock {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("user_blocks")
}

model PostView {
  id        String   @id @default(cuid())
  postId    String
  userId    String?
  viewedAt  DateTime @default(now())
  duration  Int?
  source    String?  @default("feed")
  ipAddress String?
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([postId])
  @@index([userId])
  @@index([viewedAt])
  @@map("post_views")
}

model OnboardingChecklist {
  id                String    @id @default(cuid())
  schoolId          String    @unique
  registrationDone  Boolean   @default(false)
  schoolInfoDone    Boolean   @default(false)
  calendarDone      Boolean   @default(false)
  subjectsDone      Boolean   @default(false)
  teachersAdded     Boolean   @default(false)
  classesCreated    Boolean   @default(false)
  studentsAdded     Boolean   @default(false)
  currentStep       Int       @default(1)
  totalSteps        Int       @default(7)
  completionPercent Float     @default(0)
  completedAt       DateTime?
  skippedSteps      String[]  @default([])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  school            School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("onboarding_checklists")
}

model SchoolSettings {
  id                       String   @id @default(cuid())
  schoolId                 String   @unique
  defaultAcademicYearStart String   @default("09-01")
  defaultAcademicYearEnd   String   @default("08-31")
  defaultTermCount         Int      @default(2)
  defaultClassCapacity     Int      @default(40)
  defaultSections          String[] @default(["A", "B", "C"])
  passingGrade             Float    @default(50)
  usesGPA                  Boolean  @default(true)
  emailNotifications       Boolean  @default(true)
  smsNotifications         Boolean  @default(false)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  school                   School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("school_settings")
}

model AcademicTerm {
  id             String       @id @default(cuid())
  academicYearId String
  name           String
  termNumber     Int
  startDate      DateTime
  endDate        DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  examTypes      ExamType[]

  @@unique([academicYearId, termNumber])
  @@index([academicYearId])
  @@map("academic_terms")
}

model ExamType {
  id             String        @id @default(cuid())
  academicYearId String
  termId         String?
  name           String
  weight         Float
  maxScore       Int           @default(100)
  order          Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  academicYear   AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  term           AcademicTerm? @relation(fields: [termId], references: [id])

  @@index([academicYearId])
  @@index([termId])
  @@map("exam_types")
}

model GradingScale {
  id             String       @id @default(cuid())
  academicYearId String
  name           String
  isDefault      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  ranges         GradeRange[]
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@index([academicYearId])
  @@map("grading_scales")
}

model GradeRange {
  id             String       @id @default(cuid())
  gradingScaleId String
  grade          String
  minScore       Float
  maxScore       Float
  gpa            Float?
  description    String
  color          String       @default("#10B981")
  order          Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  gradingScale   GradingScale @relation(fields: [gradingScaleId], references: [id], onDelete: Cascade)

  @@index([gradingScaleId])
  @@map("grade_ranges")
}

model AcademicCalendar {
  id             String          @id @default(cuid())
  academicYearId String
  name           String          @default("School Calendar")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  academicYear   AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  events         CalendarEvent[]

  @@index([academicYearId])
  @@map("academic_calendars")
}

model CalendarEvent {
  id          String           @id @default(cuid())
  calendarId  String
  type        EventType
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  isSchoolDay Boolean          @default(true)
  isPublic    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  calendar    AcademicCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  @@index([calendarId])
  @@index([startDate])
  @@index([type])
  @@map("calendar_events")
}

model Period {
  id               String           @id @default(cuid())
  schoolId         String
  name             String
  startTime        String
  endTime          String
  order            Int
  isBreak          Boolean          @default(false)
  duration         Int              @default(45)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  school           School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  timetableEntries TimetableEntry[]

  @@unique([schoolId, order])
  @@index([schoolId])
  @@map("periods")
}

model TimetableEntry {
  id             String       @id @default(cuid())
  schoolId       String
  classId        String
  subjectId      String?
  teacherId      String?
  periodId       String
  dayOfWeek      DayOfWeek
  room           String?
  academicYearId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  class          Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  period         Period       @relation(fields: [periodId], references: [id], onDelete: Cascade)
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject        Subject?     @relation(fields: [subjectId], references: [id])
  teacher        Teacher?     @relation(fields: [teacherId], references: [id])

  @@unique([classId, periodId, dayOfWeek, academicYearId])
  @@index([schoolId])
  @@index([classId])
  @@index([teacherId])
  @@index([periodId])
  @@index([academicYearId])
  @@map("timetable_entries")
}

model SchoolShift {
  id             String               @id @default(cuid())
  schoolId       String
  name           String
  nameKh         String?
  startTime      String
  endTime        String
  isDefault      Boolean              @default(false)
  gradeLevel     GradeLevel?
  color          String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  shiftOverrides ClassShiftOverride[]
  classShifts    ClassShift[]
  school         School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([gradeLevel])
  @@map("school_shifts")
}

model ClassShift {
  id        String      @id @default(cuid())
  classId   String      @unique
  shiftId   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  class     Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
  shift     SchoolShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@index([shiftId])
  @@map("class_shifts")
}

model ClassShiftOverride {
  id        String      @id @default(cuid())
  classId   String
  dayOfWeek DayOfWeek
  shiftId   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  class     Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
  shift     SchoolShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([classId, dayOfWeek])
  @@index([shiftId])
  @@map("class_shift_overrides")
}

model TeacherSubjectAssignment {
  id                String   @id @default(cuid())
  teacherId         String
  subjectId         String
  isPrimary         Boolean  @default(false)
  maxPeriodsPerWeek Int      @default(25)
  preferredGrades   String[]
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  subject           Subject  @relation("TeacherSubjectAssignments", fields: [subjectId], references: [id], onDelete: Cascade)
  teacher           Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
  @@index([isPrimary])
  @@map("teacher_subject_assignments")
}

model TimetableTemplate {
  id             String      @id @default(cuid())
  schoolId       String
  name           String
  description    String?
  gradeLevel     GradeLevel?
  periodsPerWeek Json
  isDefault      Boolean     @default(false)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([gradeLevel])
  @@map("timetable_templates")
}

model TimetablePublish {
  id             String                 @id @default(cuid())
  schoolId       String
  academicYearId String
  publishedAt    DateTime               @default(now())
  publishedBy    String
  status         TimetablePublishStatus @default(DRAFT)
  notifyTeachers Boolean                @default(false)
  notifyClasses  Boolean                @default(false)
  notes          String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@index([schoolId])
  @@index([academicYearId])
  @@index([status])
  @@map("timetable_publishes")
}

enum SchoolType {
  PRIMARY_SCHOOL
  MIDDLE_SCHOOL
  HIGH_SCHOOL
  COMPLETE_SCHOOL
  INTERNATIONAL
}

enum AcademicYearStatus {
  PLANNING
  ACTIVE
  ENDED
  ARCHIVED
}

enum PromotionType {
  AUTOMATIC
  MANUAL
  REPEAT
  NEW_ADMISSION
  TRANSFER_IN
  TRANSFER_OUT
}

enum SubscriptionTier {
  FREE_TRIAL_1M
  FREE_TRIAL_3M
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum AttendanceSession {
  MORNING
  AFTERNOON
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  PERMISSION
  LATE
  EXCUSED
}

enum DegreeLevel {
  CERTIFICATE
  ASSOCIATE
  BACHELOR
  MASTER
  DOCTORATE
  OTHER
}

enum Gender {
  MALE
  FEMALE
}

enum TeacherRole {
  TEACHER
  INSTRUCTOR
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  PARENT
  STAFF
}

enum WorkingLevel {
  FRAMEWORK_A
  FRAMEWORK_B
  FRAMEWORK_C
  CONTRACT
  PROBATION
}

enum StudentRole {
  GENERAL
  CLASS_LEADER
  VICE_LEADER_1
  VICE_LEADER_2
}

enum ParentRelationship {
  FATHER
  MOTHER
  GUARDIAN
  STEP_FATHER
  STEP_MOTHER
  GRANDPARENT
  OTHER
}

enum ProfileVisibility {
  PUBLIC
  SCHOOL
  CLASS
  PRIVATE
}

enum PostType {
  ARTICLE
  COURSE
  QUIZ
  QUESTION
  EXAM
  ANNOUNCEMENT
  ASSIGNMENT
  POLL
  RESOURCE
  PROJECT
  TUTORIAL
  RESEARCH
  ACHIEVEMENT
  REFLECTION
  COLLABORATION
}

enum PostVisibility {
  PUBLIC
  SCHOOL
  CLASS
  PRIVATE
}

enum NotificationType {
  LIKE
  COMMENT
  REPLY
  FOLLOW
  MENTION
  ANNOUNCEMENT
  GRADE_POSTED
  ATTENDANCE_MARKED
  SKILL_ENDORSED
  RECOMMENDATION_RECEIVED
  PROJECT_LIKED
  ACHIEVEMENT_EARNED
  COURSE_ENROLL
  ASSIGNMENT_DUE
  POLL_RESULT
}

enum ReactionType {
  LIKE
  LOVE
  HELPFUL
  INSIGHTFUL
}

enum ReportReason {
  SPAM
  HARASSMENT
  INAPPROPRIATE
  MISINFORMATION
  VIOLENCE
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  APPROVED
  REMOVED
}

enum SkillCategory {
  PROGRAMMING
  LANGUAGES
  MATHEMATICS
  SCIENCE
  HUMANITIES
  ARTS
  SPORTS
  TEACHING
  LEADERSHIP
  COMMUNICATION
  TECHNICAL
  BUSINESS
  OTHER
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum ExperienceType {
  WORK
  TEACHING
  VOLUNTEER
  INTERNSHIP
  RESEARCH
  LEADERSHIP
  EXTRACURRICULAR
}

enum ProjectCategory {
  SOFTWARE
  RESEARCH
  DESIGN
  WRITING
  SCIENCE
  MATHEMATICS
  ARTS
  ENGINEERING
  BUSINESS
  SOCIAL_IMPACT
  OTHER
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
  PUBLISHED
}

enum AchievementType {
  COURSE_COMPLETION
  SKILL_MASTERY
  TEACHING_EXCELLENCE
  COMMUNITY_CONTRIBUTION
  LEADERSHIP
  INNOVATION
  COLLABORATION
  CONSISTENCY_STREAK
  TOP_PERFORMER
  MILESTONE
  COMPETITION_WIN
  PUBLICATION
  CERTIFICATION
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum RecommendationRelation {
  TEACHER
  CLASSMATE
  MENTOR
  COLLEAGUE
  SUPERVISOR
  OTHER
}

enum EventType {
  SCHOOL_DAY
  HOLIDAY
  VACATION
  EXAM_PERIOD
  REGISTRATION
  ORIENTATION
  PARENT_MEETING
  SPORTS_DAY
  CULTURAL_EVENT
  SPECIAL_EVENT
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum GradeLevel {
  PRIMARY
  SECONDARY
  HIGH_SCHOOL
}

enum TimetablePublishStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ============================================
// PHASE 15: Teacher-Parent Messaging System
// ============================================

model Conversation {
  id            String   @id @default(cuid())
  schoolId      String
  teacherId     String
  parentId      String
  studentId     String?
  lastMessageAt DateTime @default(now())
  isArchived    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  messages Message[]
  teacher  Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  parent   Parent    @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student  Student?  @relation(fields: [studentId], references: [id], onDelete: SetNull)

  @@unique([teacherId, parentId])
  @@index([teacherId])
  @@index([parentId])
  @@index([studentId])
  @@index([lastMessageAt(sort: Desc)])
  @@map("conversations")
}

model Message {
  id             String     @id @default(cuid())
  conversationId String
  senderId       String
  senderType     SenderType
  content        String
  isRead         Boolean    @default(false)
  readAt         DateTime?
  createdAt      DateTime   @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([isRead])
  @@map("messages")
}

enum SenderType {
  TEACHER
  PARENT
}

// ============================================
// PHASE 16: Social Direct Messages (DMs)
// User-to-user messaging for the social feed
// ============================================

model DMConversation {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastMessageAt DateTime @default(now())
  lastMessage   String? // Preview of last message
  isGroup       Boolean  @default(false)
  groupName     String? // Only for group chats
  groupAvatar   String? // Only for group chats

  participants DMParticipant[]
  messages     DirectMessage[]

  @@index([lastMessageAt(sort: Desc)])
  @@map("dm_conversations")
}

model DMParticipant {
  id             String    @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime  @default(now())
  leftAt         DateTime? // Null if still in conversation
  isAdmin        Boolean   @default(false) // For group chats
  isMuted        Boolean   @default(false)
  mutedUntil     DateTime?
  lastReadAt     DateTime? // For tracking unread messages
  unreadCount    Int       @default(0)

  conversation DMConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId, leftAt])
  @@index([conversationId])
  @@map("dm_participants")
}

model DirectMessage {
  id             String        @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  messageType    DMMessageType @default(TEXT)
  mediaUrl       String? // For image/file messages
  mediaType      String? // MIME type
  replyToId      String? // For replying to messages
  isEdited       Boolean       @default(false)
  editedAt       DateTime?
  isDeleted      Boolean       @default(false)
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())

  conversation DMConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User            @relation("DMSender", fields: [senderId], references: [id], onDelete: Cascade)
  replyTo      DirectMessage?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies      DirectMessage[] @relation("MessageReplies")
  readReceipts DMReadReceipt[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([replyToId])
  @@map("direct_messages")
}

model DMReadReceipt {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  message DirectMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@map("dm_read_receipts")
}

enum DMMessageType {
  TEXT
  IMAGE
  FILE
  VOICE
  VIDEO
  STICKER
  SYSTEM // e.g., "User joined the group"
}

// ============================================
// PHASE 18: Study Clubs
// Education-focused groups for collaborative learning
// ============================================

model StudyClub {
  id          String        @id @default(cuid())
  name        String
  description String?
  clubType    StudyClubType @default(SUBJECT)
  category    String? // e.g., "Mathematics", "Programming", "Science"
  privacy     ClubPrivacy   @default(PUBLIC)
  coverImage  String?
  creatorId   String
  schoolId    String? // Optional school association
  maxMembers  Int? // Optional member limit
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  creator User              @relation("ClubCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  members StudyClubMember[]
  posts   Post[]            @relation("ClubPosts")

  @@index([creatorId])
  @@index([clubType])
  @@index([privacy])
  @@index([category])
  @@index([schoolId])
  @@map("study_clubs")
}

model StudyClubMember {
  id        String         @id @default(cuid())
  clubId    String
  userId    String
  role      ClubMemberRole @default(MEMBER)
  joinedAt  DateTime       @default(now())
  invitedBy String? // Who invited this member

  club StudyClub @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([userId])
  @@index([clubId])
  @@map("study_club_members")
}

enum StudyClubType {
  SUBJECT // Math Club, Science Club, Literature Club
  SKILL // Coding Club, Debate Club, Public Speaking
  RESEARCH // Research groups for specific topics
  PROJECT // Project teams for collaborative work
  EXAM_PREP // Exam preparation study groups
  LANGUAGE // Language learning clubs
  COMPETITION // Olympiad, competitions preparation
  TUTORING // Peer tutoring and mentoring
}

enum ClubPrivacy {
  PUBLIC // Anyone can see and join
  SCHOOL // Only school members can see and join
  PRIVATE // Invite-only, visible to members
  SECRET // Invite-only, hidden from search
}

enum ClubMemberRole {
  OWNER // Creator of the club
  ADMIN // Can manage members and settings
  MODERATOR // Can moderate posts and comments
  MEMBER // Regular member
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model School {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  email               String               @unique
  phone               String?
  address             String?
  logo                String?
  website             String?
  subscriptionTier    SubscriptionTier     @default(FREE_TRIAL_1M)
  subscriptionStart   DateTime             @default(now())
  subscriptionEnd     DateTime?
  isActive            Boolean              @default(true)
  isTrial             Boolean              @default(true)
  maxStudents         Int                  @default(100)
  maxTeachers         Int                  @default(10)
  maxStorage          BigInt               @default(1073741824)
  currentStudents     Int                  @default(0)
  currentTeachers     Int                  @default(0)
  currentStorage      BigInt               @default(0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  gradeRange          String               @default("7-12")
  onboardingStep      Int                  @default(0)
  schoolType          SchoolType           @default(HIGH_SCHOOL)
  setupCompleted      Boolean              @default(false)
  setupCompletedAt    DateTime?
  workingDays         Int[]                @default([1, 2, 3, 4, 5])
  countryCode         String?              @default("KH")
  idFormat            IdFormat             @default(STRUCTURED)
  idPrefix            String?              @default("01")
  nextStudentNumber   Int                  @default(1)
  nextTeacherNumber   Int                  @default(1)
  regionCode          String?
  registrationStatus  RegistrationStatus   @default(APPROVED)
  academicYears       AcademicYear[]
  claimCodes          ClaimCode[]
  classes             Class[]
  featureFlags        FeatureFlag[]
  idGenerationLogs    IdGenerationLog[]
  onboardingChecklist OnboardingChecklist?
  periods             Period[]
  SchoolLocation      SchoolLocation[]
  schoolSettings      SchoolSettings?
  schoolShifts        SchoolShift[]
  students            Student[]
  studyClubs          StudyClub[]
  teachers            Teacher[]
  timetableEntries    TimetableEntry[]
  users               User[]

  @@index([slug])
  @@index([subscriptionTier])
  @@index([isActive])
  @@index([registrationStatus])
  @@map("schools")
}

model AcademicYear {
  id               String               @id @default(cuid())
  schoolId         String
  name             String
  startDate        DateTime
  endDate          DateTime
  isCurrent        Boolean              @default(false)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  copiedFromYearId String?
  isPromotionDone  Boolean              @default(false)
  promotionDate    DateTime?
  status           AcademicYearStatus   @default(PLANNING)
  calendars        AcademicCalendar[]
  terms            AcademicTerm[]
  copiedFromYear   AcademicYear?        @relation("YearCopy", fields: [copiedFromYearId], references: [id])
  copiedToYears    AcademicYear[]       @relation("YearCopy")
  school           School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes          Class[]
  examTypes        ExamType[]
  gradingScales    GradingScale[]
  progressionsFrom StudentProgression[] @relation("FromYear")
  progressionsTo   StudentProgression[] @relation("ToYear")
  timetableEntries TimetableEntry[]

  @@unique([schoolId, name])
  @@index([schoolId, isCurrent])
  @@index([schoolId, status])
  @@map("academic_years")
}

model StudentProgression {
  id                 String        @id @default(cuid())
  studentId          String
  fromAcademicYearId String
  toAcademicYearId   String
  fromClassId        String
  toClassId          String
  promotionType      PromotionType
  promotionDate      DateTime
  promotedBy         String
  notes              String?
  createdAt          DateTime      @default(now())
  fromAcademicYear   AcademicYear  @relation("FromYear", fields: [fromAcademicYearId], references: [id])
  fromClass          Class         @relation("FromClass", fields: [fromClassId], references: [id])
  student            Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  toAcademicYear     AcademicYear  @relation("ToYear", fields: [toAcademicYearId], references: [id])
  toClass            Class         @relation("ToClass", fields: [toClassId], references: [id])

  @@unique([studentId, fromAcademicYearId, toAcademicYearId])
  @@index([studentId])
  @@index([fromAcademicYearId])
  @@index([toAcademicYearId])
  @@map("student_progressions")
}

model Attendance {
  id        String            @id @default(cuid())
  studentId String
  classId   String?
  date      DateTime
  status    AttendanceStatus
  remarks   String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  session   AttendanceSession @default(MORNING)
  class     Class?            @relation(fields: [classId], references: [id])
  student   Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, date, session])
  @@index([classId, date])
  @@index([studentId, date])
  @@index([date, status])
  @@map("attendance")
}

model Class {
  id                      String                  @id @default(cuid())
  schoolId                String
  classId                 String?                 @unique
  name                    String
  grade                   String
  section                 String?
  capacity                Int?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  track                   String?
  homeroomTeacherId       String?                 @unique
  academicYearId          String
  attendance              Attendance[]
  classShiftOverrides     ClassShiftOverride[]
  classShift              ClassShift?
  academicYear            AcademicYear            @relation(fields: [academicYearId], references: [id])
  school                  School                  @relation(fields: [schoolId], references: [id])
  grades                  Grade[]
  studentClasses          StudentClass[]
  studentMonthlySummaries StudentMonthlySummary[]
  progressionsFrom        StudentProgression[]    @relation("FromClass")
  progressionsTo          StudentProgression[]    @relation("ToClass")
  students                Student[]
  teacherClasses          TeacherClass[]
  homeroomTeacher         Teacher?
  timetableEntries        TimetableEntry[]

  @@index([schoolId])
  @@index([grade])
  @@index([schoolId, grade])
  @@index([academicYearId])
  @@index([schoolId, academicYearId])
  @@map("classes")
}

model Grade {
  id            String   @id @default(cuid())
  studentId     String
  subjectId     String
  classId       String
  score         Float
  maxScore      Float
  month         String?
  monthNumber   Int?
  year          Int?
  percentage    Float?
  weightedScore Float?
  remarks       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  class         Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject       Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([studentId, subjectId, classId, month, year])
  @@index([classId, month, year])
  @@index([studentId, month, year])
  @@index([subjectId, classId])
  @@map("grades")
}

model GradeConfirmation {
  id          String   @id @default(cuid())
  classId     String
  subjectId   String
  month       String
  year        Int
  isConfirmed Boolean  @default(false)
  confirmedBy String
  confirmedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [confirmedBy], references: [id], onDelete: Cascade)

  @@unique([classId, subjectId, month, year])
  @@index([classId, month, year])
  @@index([confirmedBy])
  @@map("grade_confirmations")
}

model StudentMonthlySummary {
  id                 String   @id @default(cuid())
  studentId          String
  classId            String
  month              String
  monthNumber        Int
  year               Int
  totalScore         Float
  totalMaxScore      Float
  totalWeightedScore Float
  totalCoefficient   Float
  average            Float
  classRank          Int?
  gradeLevel         String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  class              Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student            Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, month, year])
  @@index([classId, month, year])
  @@index([studentId, year])
  @@index([month, year, average])
  @@map("student_monthly_summaries")
}

model Student {
  id                   String                  @id @default(cuid())
  schoolId             String
  studentId            String?                 @unique
  firstName            String
  lastName             String
  dateOfBirth          String
  gender               Gender
  email                String?                 @unique
  phoneNumber          String?
  classId              String?
  photoUrl             String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  accountDeactivatedAt DateTime?
  deactivationReason   String?
  isAccountActive      Boolean                 @default(true)
  studentRole          StudentRole             @default(GENERAL)
  entryYear            Int?
  permanentId          String?                 @unique
  studentIdFormat      IdFormat?
  customFields         Json?                   // flexible country/school-specific data
  studentIdMeta        Json?
  attendance           Attendance[]
  claimCode            ClaimCode?
  conversations        Conversation[]
  grades               Grade[]
  studentClasses       StudentClass[]
  monthlySummaries     StudentMonthlySummary[]
  studentParents       StudentParent[]
  StudentProgression   StudentProgression[]
  class                Class?                  @relation(fields: [classId], references: [id])
  school               School                  @relation(fields: [schoolId], references: [id])
  user                 User?

  @@index([schoolId])
  @@index([classId])
  @@index([gender])
  @@index([isAccountActive])
  @@index([classId, studentRole])
  @@index([schoolId, classId])
  @@index([schoolId, isAccountActive])
  @@index([schoolId, firstName, lastName])
  @@index([schoolId, createdAt])
  @@index([permanentId])
  @@index([entryYear])
  @@map("students")
}

model Parent {
  id              String             @id @default(cuid())
  parentId        String?            @unique
  firstName       String
  lastName        String
  englishName     String?
  gender          Gender?
  email           String?            @unique
  phone           String             @unique
  address         String?
  relationship    ParentRelationship
  occupation      String?            @default("កសិករ")
  emergencyPhone  String?
  isAccountActive Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  customFields    Json?              // flexible country/school-specific data
  conversations   Conversation[]
  studentParents  StudentParent[]
  user            User?

  @@index([phone, isAccountActive])
  @@index([email, isAccountActive])
  @@map("parents")
}

model StudentParent {
  id           String             @id @default(cuid())
  studentId    String
  parentId     String
  isPrimary    Boolean            @default(false)
  relationship ParentRelationship
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  parent       Parent             @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student      Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId])
  @@index([studentId])
  @@index([parentId])
  @@map("student_parents")
}

model StudentClass {
  id             String   @id @default(cuid())
  studentId      String
  classId        String
  academicYearId String?
  enrolledAt     DateTime @default(now())
  status         String   @default("ACTIVE")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  class          Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student        Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId, academicYearId])
  @@index([studentId])
  @@index([classId])
  @@index([status])
  @@map("student_classes")
}

model SubjectTeacher {
  id        String   @id @default(cuid())
  subjectId String
  teacherId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([subjectId, teacherId])
  @@map("subject_teachers")
}

model Subject {
  id                        String                     @id @default(cuid())
  name                      String
  nameKh                    String
  nameEn                    String?
  code                      String                     @unique
  description               String?
  grade                     String
  track                     String?
  category                  String
  weeklyHours               Float                      @default(0)
  annualHours               Int                        @default(0)
  maxScore                  Int                        @default(100)
  coefficient               Float                      @default(1.0)
  isActive                  Boolean                    @default(true)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  customFields              Json?                      // e.g. { localName, examWeight, curriculumRef }
  grades                    Grade[]
  subjectTeachers           SubjectTeacher[]
  teacherSubjectAssignments TeacherSubjectAssignment[] @relation("TeacherSubjectAssignments")
  timetableEntries          TimetableEntry[]

  @@index([grade, isActive])
  @@index([grade, track, isActive])
  @@map("subjects")
}

model TeacherClass {
  id        String   @id @default(cuid())
  teacherId String
  classId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, classId])
  @@map("teacher_classes")
}

model Teacher {
  id                        String                     @id @default(cuid())
  schoolId                  String
  teacherId                 String?                    @unique
  firstName                 String
  lastName                  String
  email                     String?                    @unique
  phone                     String?                    @unique
  employeeId                String?                    @unique
  gender                    Gender?
  dateOfBirth               String?
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  address                   String?
  hireDate                  String?
  homeroomClassId           String?                    @unique
  role                      TeacherRole                @default(TEACHER)
  photoUrl                  String?
  hireYear                  Int?
  permanentId               String?                    @unique
  teacherIdFormat           IdFormat?
  teacherIdMeta             Json?
  customFields              Json?                      // flexible country/school-specific data
  claimCode                 ClaimCode?
  conversations             Conversation[]
  subjectTeachers           SubjectTeacher[]
  TeacherAttendance         TeacherAttendance[]
  teacherClasses            TeacherClass[]
  teacherSubjectAssignments TeacherSubjectAssignment[]
  homeroomClass             Class?                     @relation(fields: [homeroomClassId], references: [id])
  school                    School                     @relation(fields: [schoolId], references: [id])
  timetableEntries          TimetableEntry[]
  user                      User?

  @@index([schoolId])
  @@index([schoolId, createdAt])
  @@index([email])
  @@index([permanentId])
  @@index([hireYear])
  @@map("teachers")
}

model User {
  id                          String                       @id @default(cuid())
  schoolId                    String?
  email                       String?                      @unique
  password                    String
  firstName                   String
  lastName                    String
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
  failedAttempts              Int                          @default(0)
  isActive                    Boolean                      @default(true)
  lastLogin                   DateTime?
  lockedUntil                 DateTime?
  loginCount                  Int                          @default(0)
  permissions                 Json?                        @default("{\"canEnterGrades\": true, \"canViewReports\": true, \"canMarkAttendance\": true}")
  phone                       String?                      @unique
  studentId                   String?                      @unique
  teacherId                   String?                      @unique
  role                        UserRole                     @default(TEACHER)
  accountSuspendedAt          DateTime?
  isDefaultPassword           Boolean                      @default(true)
  isSuperAdmin                Boolean                      @default(false)
  lastPasswordHashes          String[]
  passwordChangedAt           DateTime?
  passwordExpiresAt           DateTime?
  passwordResetExpiry         DateTime?
  passwordResetToken          String?                      @unique
  suspensionReason            String?
  parentId                    String?                      @unique
  profilePictureUrl           String?
  profilePictureKey           String?
  coverPhotoUrl               String?
  coverPhotoKey               String?
  bio                         String?
  headline                    String?
  interests                   String[]
  skills                      String[]
  socialLinks                 Json?
  profileCompleteness         Int                          @default(0)
  profileUpdatedAt            DateTime?
  profileVisibility           ProfileVisibility            @default(SCHOOL)
  careerGoals                 String?
  location                    String?
  languages                   String[]
  professionalTitle           String?
  isVerified                  Boolean                      @default(false)
  verifiedAt                  DateTime?
  totalLearningHours          Int                          @default(0)
  currentStreak               Int                          @default(0)
  longestStreak               Int                          @default(0)
  totalPoints                 Int                          @default(0)
  level                       Int                          @default(1)
  isOpenToOpportunities       Boolean                      @default(false)
  resumeUrl                   String?
  resumeKey                   String?
  accountType                 AccountType                  @default(SOCIAL_ONLY)
  emailVerificationExpiry     DateTime?
  emailVerificationToken      String?                      @unique
  isEmailVerified             Boolean                      @default(false)
  organizationCode            String?
  organizationName            String?
  organizationType            String?
  privacySettings             Json?
  socialFeaturesEnabled       Boolean                      @default(true)
  ssoAccessToken              String?
  ssoId                       String?
  ssoProvider                 String?
  challengeParticipations     ChallengeParticipant[]
  learningStreak              LearningStreak?
  quizAttemptRecords          QuizAttemptRecord[]
  challengesAsChallenger      QuizChallenge[]              @relation("ChallengerChallenges")
  challengesAsOpponent        QuizChallenge[]              @relation("OpponentChallenges")
  gameAchievements            UserGameAchievement[]
  stats                       UserStats?
  weeklyLeaderboards          WeeklyLeaderboard[]
  achievements                Achievement[]
  attendanceStreak            AttendanceStreak?
  adminAuditLogs              AuditLog[]                   @relation("AuditLogAdmin")
  teacherAuditLogs            AuditLog[]                   @relation("AuditLogTeacher")
  bookmarks                   Bookmark[]                   @relation("UserBookmarks")
  certifications              Certification[]
  userChallenges              Challenge[]
  claimedCode                 ClaimCode?
  clubAnnouncements           ClubAnnouncement[]           @relation("ClubAnnouncementCreator")
  clubSubmissionGrading       ClubAssignmentSubmission[]   @relation("ClubSubmissionGrader")
  clubAssignments             ClubAssignment[]             @relation("ClubAssignmentCreator")
  clubAttendanceMarking       ClubAttendance[]             @relation("ClubAttendanceMarker")
  clubAwardsGiven             ClubAward[]                  @relation("ClubAwardGiver")
  clubGrades                  ClubGrade[]                  @relation("ClubGrader")
  clubMaterialsUploaded       ClubMaterial[]               @relation("ClubMaterialUploader")
  clubMemberships             ClubMember[]                 @relation("ClubMemberships")
  clubReportsGenerated        ClubReport[]                 @relation("ClubReportGenerator")
  clubSessions                ClubSession[]                @relation("ClubSessionCreator")
  clubInstructions            ClubSubject[]                @relation("ClubInstructor")
  commentReactions            CommentReaction[]
  comments                    Comment[]
  courseReviews               CourseReview[]
  createdCourses              Course[]                     @relation("CourseInstructor")
  deviceTokens                DeviceToken[]
  sentDirectMessages          DirectMessage[]              @relation("DMSender")
  dmParticipations            DMParticipant[]
  dmReadReceipts              DMReadReceipt[]
  education                   Education[]
  enrollments                 Enrollment[]
  eventAttendances            EventAttendee[]
  createdEvents               Event[]                      @relation("EventCreator")
  experiences                 Experience[]
  following                   Follow[]                     @relation("Following")
  followers                   Follow[]                     @relation("Followers")
  gradeConfirmations          GradeConfirmation[]
  createdPaths                LearningPath[]               @relation("PathCreator")
  likes                       Like[]
  milestoneEvents             MilestoneEvent[]
  sentNotifications           Notification[]               @relation("NotificationActor")
  notifications               Notification[]               @relation("NotificationRecipient")
  platformAuditLogs           PlatformAuditLog[]
  pollVotes                   PollVote[]                   @relation("PollVotes")
  reportedPosts               PostReport[]                 @relation("PostReporter")
  reviewedReports             PostReport[]                 @relation("ReportReviewer")
  postViews                   PostView[]
  posts                       Post[]
  projects                    Project[]
  quizAttempts                QuizAttempt[]                @relation("QuizAttempts")
  givenRecommendations        Recommendation[]             @relation("RecommendationAuthor")
  recommendations             Recommendation[]             @relation("RecommendationRecipient")
  endorsementsGiven           SkillEndorsement[]           @relation("EndorsementGiver")
  endorsementsReceived        SkillEndorsement[]           @relation("EndorsementRecipient")
  socialAccounts              SocialAccount[]
  stories                     Story[]                      @relation("UserStories")
  createdStudyClubs           StudyClub[]                  @relation("ClubCreator")
  teamChallengeParticipations TeamChallengeParticipant[]
  twoFactorSecret             TwoFactorSecret?
  academicProfile             UserAcademicProfile?
  achievementProgress         UserAchievementProgress[]
  blockedBy                   UserBlock[]                  @relation("Blocked")
  blocking                    UserBlock[]                  @relation("Blocker")
  deadlines                   UserDeadline[]
  feedSignals                 UserFeedSignal[]
  userSkills                  UserSkill[]
  unlockables                 UserUnlockable[]
  parent                      Parent?                      @relation(fields: [parentId], references: [id], onDelete: Cascade)
  school                      School?                      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student                     Student?                     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher                     Teacher?                     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  currency                    VirtualCurrency?
  currencyTransactions        VirtualCurrencyTransaction[]

  @@index([email, isActive])
  @@index([phone, isActive])
  @@index([studentId, isActive])
  @@index([parentId, isActive])
  @@index([isDefaultPassword])
  @@index([passwordExpiresAt])
  @@index([schoolId])
  @@index([schoolId, role, isActive])
  @@index([schoolId, isActive])
  @@index([ssoProvider, ssoId])
  @@index([organizationCode])
  @@index([accountType])
  @@index([isEmailVerified])
  @@map("users")
}

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String
  teacherId String
  action    String
  reason    String?
  details   Json?
  createdAt DateTime @default(now())
  admin     User     @relation("AuditLogAdmin", fields: [adminId], references: [id])
  teacher   User     @relation("AuditLogTeacher", fields: [teacherId], references: [id])

  @@index([adminId])
  @@index([teacherId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Post {
  id                       String         @id @default(cuid())
  authorId                 String
  content                  String
  mediaUrls                String[]
  mediaKeys                String[]
  postType                 PostType       @default(ARTICLE)
  visibility               PostVisibility @default(SCHOOL)
  likesCount               Int            @default(0)
  commentsCount            Int            @default(0)
  sharesCount              Int            @default(0)
  isEdited                 Boolean        @default(false)
  isPinned                 Boolean        @default(false)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  pollExpiresAt            DateTime?
  pollAllowMultiple        Boolean        @default(false)
  pollMaxChoices           Int?
  pollIsAnonymous          Boolean        @default(false)
  assignmentDueDate        DateTime?
  assignmentPoints         Int?
  assignmentSubmissionType String?
  courseCode               String?
  courseLevel              String?
  courseDuration           String?
  announcementUrgency      String?
  announcementExpiryDate   DateTime?
  tutorialDifficulty       String?
  tutorialEstimatedTime    String?
  tutorialPrerequisites    String?
  examDate                 DateTime?
  examDuration             Int?
  examTotalPoints          Int?
  examPassingScore         Int?
  resourceType             String?
  resourceUrl              String?
  researchField            String?
  researchCollaborators    String?
  projectStatus            String?
  projectDeadline          DateTime?
  projectTeamSize          Int?
  mediaDisplayMode         String?        @default("AUTO")
  studyClubId              String?
  difficultyLevel          Decimal?       @default(2.5) @db.Decimal(3, 2)
  questionBounty           Int            @default(0)
  repostComment            String?
  repostOfId               String?
  title                    String?
  topicTags                String[]
  trendingScore            Float          @default(0)
  bookmarks                Bookmark[]
  comments                 Comment[]
  likes                    Like[]
  pollOptions              PollOption[]
  postScore                PostScore?
  views                    PostView[]
  author                   User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  repostOf                 Post?          @relation("Reposts", fields: [repostOfId], references: [id])
  reposts                  Post[]         @relation("Reposts")
  studyClub                StudyClub?     @relation("ClubPosts", fields: [studyClubId], references: [id])
  quizQuestions            QuizQuestion[]
  quiz                     Quiz?

  @@index([authorId, createdAt(sort: Desc)])
  @@index([postType, createdAt(sort: Desc)])
  @@index([visibility, createdAt(sort: Desc)])
  @@index([trendingScore(sort: Desc)])
  @@index([pollExpiresAt])
  @@index([studyClubId])
  @@index([isPinned, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([visibility, isPinned(sort: Desc), createdAt(sort: Desc)])
  @@index([authorId, postType, createdAt(sort: Desc)])
  @@index([authorId, visibility, createdAt(sort: Desc)])
  @@index([studyClubId, createdAt(sort: Desc)])
  @@map("posts")
}

model Comment {
  id               String            @id @default(cuid())
  postId           String
  authorId         String
  content          String
  parentId         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  isVerifiedAnswer Boolean           @default(false)
  reactions        CommentReaction[]
  author           User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent           Comment?          @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies          Comment[]         @relation("CommentReplies")
  post             Post              @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt(sort: Desc)])
  @@index([authorId])
  @@index([parentId])
  @@map("comments")
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
  @@index([postId])
  @@map("likes")
}

model Bookmark {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation("UserBookmarks", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
  @@map("bookmarks")
}

model PollOption {
  id         String     @id @default(cuid())
  postId     String
  text       String
  position   Int        @default(0)
  votesCount Int        @default(0)
  createdAt  DateTime   @default(now())
  post       Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  votes      PollVote[]

  @@index([postId])
  @@map("poll_options")
}

model QuizQuestion {
  id            String   @id @default(cuid())
  postId        String
  question      String
  options       String[]
  correctAnswer Int
  points        Int      @default(10)
  position      Int      @default(0)
  explanation   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  post          Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("quiz_questions")
}

model Quiz {
  id                String              @id @default(cuid())
  postId            String              @unique
  questions         Json
  timeLimit         Int
  passingScore      Int
  totalPoints       Int
  resultsVisibility String              @default("AFTER_SUBMISSION")
  shuffleQuestions  Boolean             @default(false)
  shuffleAnswers    Boolean             @default(false)
  maxAttempts       Int?
  showReview        Boolean             @default(true)
  showExplanations  Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  attemptRecords    QuizAttemptRecord[]
  challenges        QuizChallenge[]
  attempts          QuizAttempt[]
  post              Post                @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("quizzes")
}

model QuizAttempt {
  id           String   @id @default(cuid())
  quizId       String
  userId       String
  answers      Json
  score        Int
  pointsEarned Int
  passed       Boolean
  submittedAt  DateTime @default(now())
  quiz         Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user         User     @relation("QuizAttempts", fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([userId])
  @@index([quizId, userId])
  @@map("quiz_attempts")
}

model PollVote {
  id        String     @id @default(cuid())
  postId    String
  optionId  String
  userId    String
  createdAt DateTime   @default(now())
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  user      User       @relation("PollVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, optionId, userId])
  @@index([userId])
  @@index([postId, userId])
  @@map("poll_votes")
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followingId])
  @@index([followerId])
  @@map("follows")
}

model Notification {
  id          String           @id @default(cuid())
  recipientId String
  actorId     String?
  type        NotificationType
  title       String
  message     String
  link        String?
  postId      String?
  commentId   String?
  isRead      Boolean          @default(false)
  readAt      DateTime?
  createdAt   DateTime         @default(now())
  actor       User?            @relation("NotificationActor", fields: [actorId], references: [id])
  recipient   User             @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId, isRead, createdAt(sort: Desc)])
  @@index([actorId])
  @@map("notifications")
}

model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String   @default("unknown")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("device_tokens")
}

model UserSkill {
  id           String             @id @default(cuid())
  userId       String
  skillName    String
  category     SkillCategory
  level        SkillLevel         @default(BEGINNER)
  yearsOfExp   Float?
  isVerified   Boolean            @default(false)
  verifiedBy   String?
  verifiedAt   DateTime?
  description  String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  endorsements SkillEndorsement[]
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillName])
  @@index([userId, category])
  @@index([skillName])
  @@map("user_skills")
}

model SkillEndorsement {
  id          String    @id @default(cuid())
  skillId     String
  endorserId  String
  recipientId String
  comment     String?
  createdAt   DateTime  @default(now())
  endorser    User      @relation("EndorsementGiver", fields: [endorserId], references: [id], onDelete: Cascade)
  recipient   User      @relation("EndorsementRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  skill       UserSkill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([skillId, endorserId])
  @@index([recipientId])
  @@index([endorserId])
  @@map("skill_endorsements")
}

model Experience {
  id           String         @id @default(cuid())
  userId       String
  type         ExperienceType
  title        String
  organization String
  location     String?
  startDate    DateTime
  endDate      DateTime?
  isCurrent    Boolean        @default(false)
  description  String?
  achievements String[]
  skills       String[]
  mediaUrls    String[]
  mediaKeys    String[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startDate(sort: Desc)])
  @@index([type])
  @@map("experiences")
}

model Certification {
  id             String    @id @default(cuid())
  userId         String
  name           String
  issuingOrg     String
  issueDate      DateTime
  expiryDate     DateTime?
  credentialId   String?
  credentialUrl  String?
  certificateUrl String?
  certificateKey String?
  description    String?
  skills         String[]
  isVerified     Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, issueDate(sort: Desc)])
  @@map("certifications")
}

model Education {
  id           String    @id @default(cuid())
  userId       String
  school       String
  degree       String?
  fieldOfStudy String?
  grade        String?
  startDate    DateTime
  endDate      DateTime?
  isCurrent    Boolean   @default(false)
  description  String?
  activities   String[]
  skills       String[]
  mediaUrls    String[]
  mediaKeys    String[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startDate(sort: Desc)])
  @@map("education")
}

model Project {
  id            String            @id @default(cuid())
  userId        String
  title         String
  description   String
  category      ProjectCategory
  status        ProjectStatus     @default(COMPLETED)
  startDate     DateTime?
  endDate       DateTime?
  role          String?
  teamSize      Int?
  technologies  String[]
  skills        String[]
  mediaUrls     String[]
  mediaKeys     String[]
  projectUrl    String?
  githubUrl     String?
  demoUrl       String?
  achievements  String[]
  collaborators String[]
  visibility    ProfileVisibility @default(PUBLIC)
  viewsCount    Int               @default(0)
  likesCount    Int               @default(0)
  isFeatured    Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([category, visibility])
  @@index([isFeatured])
  @@map("projects")
}

model Achievement {
  id             String            @id @default(cuid())
  userId         String
  type           AchievementType
  title          String
  description    String
  issuedBy       String?
  issuedDate     DateTime          @default(now())
  badgeUrl       String?
  badgeKey       String?
  certificateUrl String?
  certificateKey String?
  points         Int               @default(0)
  rarity         AchievementRarity @default(COMMON)
  isPublic       Boolean           @default(true)
  metadata       Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, issuedDate(sort: Desc)])
  @@index([type, rarity])
  @@map("achievements")
}

model Recommendation {
  id           String                 @id @default(cuid())
  recipientId  String
  authorId     String
  relationship RecommendationRelation
  content      String
  skills       String[]
  rating       Int?
  isPublic     Boolean                @default(true)
  isAccepted   Boolean                @default(false)
  acceptedAt   DateTime?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  author       User                   @relation("RecommendationAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  recipient    User                   @relation("RecommendationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([recipientId, authorId])
  @@index([recipientId, isAccepted])
  @@index([authorId])
  @@map("recommendations")
}

model CommentReaction {
  id        String       @id @default(cuid())
  commentId String
  userId    String
  type      ReactionType
  createdAt DateTime     @default(now())
  comment   Comment      @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId, type])
  @@index([commentId])
  @@index([userId])
  @@map("comment_reactions")
}

model PostReport {
  id         String       @id @default(cuid())
  postId     String
  reporterId String
  reason     ReportReason
  details    String?
  status     ReportStatus @default(PENDING)
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime     @default(now())
  reporter   User         @relation("PostReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reviewer   User?        @relation("ReportReviewer", fields: [reviewedBy], references: [id])

  @@index([postId, status])
  @@index([reporterId])
  @@index([status, createdAt])
  @@map("post_reports")
}

model UserBlock {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("user_blocks")
}

model PostView {
  id        String   @id @default(cuid())
  postId    String
  userId    String?
  viewedAt  DateTime @default(now())
  duration  Int?
  source    String?  @default("feed")
  ipAddress String?
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([postId])
  @@index([userId])
  @@index([viewedAt])
  @@index([postId, userId])
  @@index([postId, viewedAt(sort: Desc)])
  @@map("post_views")
}

model UserFeedSignal {
  id              String   @id @default(cuid())
  userId          String
  topicId         String
  score           Float    @default(0)
  viewCount       Int      @default(0)
  likeCount       Int      @default(0)
  commentCount    Int      @default(0)
  shareCount      Int      @default(0)
  bookmarkCount   Int      @default(0)
  avgViewDuration Float    @default(0)
  lastInteraction DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@index([userId])
  @@index([score(sort: Desc)])
  @@index([userId, score(sort: Desc)])
  @@map("user_feed_signals")
}

model PostScore {
  id              String   @id @default(cuid())
  postId          String   @unique
  engagementScore Float    @default(0)
  qualityScore    Float    @default(0)
  trendingScore   Float    @default(0)
  decayFactor     Float    @default(1.0)
  computedAt      DateTime @default(now())
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([engagementScore(sort: Desc)])
  @@index([trendingScore(sort: Desc)])
  @@map("post_scores")
}

model OnboardingChecklist {
  id                String    @id @default(cuid())
  schoolId          String    @unique
  registrationDone  Boolean   @default(false)
  schoolInfoDone    Boolean   @default(false)
  calendarDone      Boolean   @default(false)
  subjectsDone      Boolean   @default(false)
  teachersAdded     Boolean   @default(false)
  classesCreated    Boolean   @default(false)
  studentsAdded     Boolean   @default(false)
  currentStep       Int       @default(1)
  totalSteps        Int       @default(7)
  completionPercent Float     @default(0)
  completedAt       DateTime?
  skippedSteps      String[]  @default([])
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  school            School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("onboarding_checklists")
}

model SchoolSettings {
  id                       String   @id @default(cuid())
  schoolId                 String   @unique
  defaultAcademicYearStart String   @default("09-01")
  defaultAcademicYearEnd   String   @default("08-31")
  defaultTermCount         Int      @default(2)
  defaultClassCapacity     Int      @default(40)
  defaultSections          String[] @default(["A", "B", "C"])
  passingGrade             Float    @default(50)
  usesGPA                  Boolean  @default(true)
  emailNotifications       Boolean  @default(true)
  smsNotifications         Boolean  @default(false)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  school                   School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("school_settings")
}

model AcademicTerm {
  id             String       @id @default(cuid())
  academicYearId String
  name           String
  termNumber     Int
  startDate      DateTime
  endDate        DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  examTypes      ExamType[]

  @@unique([academicYearId, termNumber])
  @@index([academicYearId])
  @@map("academic_terms")
}

model ExamType {
  id             String        @id @default(cuid())
  academicYearId String
  termId         String?
  name           String
  weight         Float
  maxScore       Int           @default(100)
  order          Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  academicYear   AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  term           AcademicTerm? @relation(fields: [termId], references: [id])

  @@index([academicYearId])
  @@index([termId])
  @@map("exam_types")
}

model GradingScale {
  id             String       @id @default(cuid())
  academicYearId String
  name           String
  isDefault      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  ranges         GradeRange[]
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@index([academicYearId])
  @@map("grading_scales")
}

model GradeRange {
  id             String       @id @default(cuid())
  gradingScaleId String
  grade          String
  minScore       Float
  maxScore       Float
  gpa            Float?
  description    String
  color          String       @default("#10B981")
  order          Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  gradingScale   GradingScale @relation(fields: [gradingScaleId], references: [id], onDelete: Cascade)

  @@index([gradingScaleId])
  @@map("grade_ranges")
}

model AcademicCalendar {
  id             String          @id @default(cuid())
  academicYearId String
  name           String          @default("School Calendar")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  academicYear   AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  events         CalendarEvent[]

  @@index([academicYearId])
  @@map("academic_calendars")
}

model CalendarEvent {
  id          String           @id @default(cuid())
  calendarId  String
  type        EventType
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  isSchoolDay Boolean          @default(true)
  isPublic    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  calendar    AcademicCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  @@index([calendarId])
  @@index([startDate])
  @@index([type])
  @@map("calendar_events")
}

model Period {
  id               String           @id @default(cuid())
  schoolId         String
  name             String
  startTime        String
  endTime          String
  order            Int
  isBreak          Boolean          @default(false)
  duration         Int              @default(45)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  school           School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  timetableEntries TimetableEntry[]

  @@unique([schoolId, order])
  @@index([schoolId])
  @@map("periods")
}

model TimetableEntry {
  id             String       @id @default(cuid())
  schoolId       String
  classId        String
  subjectId      String?
  teacherId      String?
  periodId       String
  dayOfWeek      DayOfWeek
  room           String?
  academicYearId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  class          Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  period         Period       @relation(fields: [periodId], references: [id], onDelete: Cascade)
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject        Subject?     @relation(fields: [subjectId], references: [id])
  teacher        Teacher?     @relation(fields: [teacherId], references: [id])

  @@unique([classId, periodId, dayOfWeek, academicYearId])
  @@index([schoolId])
  @@index([classId])
  @@index([teacherId])
  @@index([periodId])
  @@index([academicYearId])
  @@map("timetable_entries")
}

model SchoolShift {
  id             String               @id @default(cuid())
  schoolId       String
  name           String
  nameKh         String?
  startTime      String
  endTime        String
  isDefault      Boolean              @default(false)
  gradeLevel     GradeLevel?
  color          String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  shiftOverrides ClassShiftOverride[]
  classShifts    ClassShift[]
  school         School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([gradeLevel])
  @@map("school_shifts")
}

model ClassShift {
  id        String      @id @default(cuid())
  classId   String      @unique
  shiftId   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  class     Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
  shift     SchoolShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@index([shiftId])
  @@map("class_shifts")
}

model ClassShiftOverride {
  id        String      @id @default(cuid())
  classId   String
  dayOfWeek DayOfWeek
  shiftId   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  class     Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
  shift     SchoolShift @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([classId, dayOfWeek])
  @@index([shiftId])
  @@map("class_shift_overrides")
}

model TeacherSubjectAssignment {
  id                String   @id @default(cuid())
  teacherId         String
  subjectId         String
  isPrimary         Boolean  @default(false)
  maxPeriodsPerWeek Int      @default(25)
  preferredGrades   String[]
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  subject           Subject  @relation("TeacherSubjectAssignments", fields: [subjectId], references: [id], onDelete: Cascade)
  teacher           Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
  @@index([isPrimary])
  @@map("teacher_subject_assignments")
}

model ClaimCode {
  id               String        @id @default(cuid())
  code             String        @unique
  type             ClaimCodeType
  schoolId         String
  studentId        String?       @unique
  teacherId        String?       @unique
  expiresAt        DateTime
  createdAt        DateTime      @default(now())
  claimedAt        DateTime?
  claimedByUserId  String?       @unique
  verificationData Json?
  isActive         Boolean       @default(true)
  revokedAt        DateTime?
  revokedBy        String?
  revokedReason    String?
  claimedByUser    User?         @relation(fields: [claimedByUserId], references: [id])
  school           School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student          Student?      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher          Teacher?      @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([schoolId])
  @@index([studentId])
  @@index([teacherId])
  @@index([type])
  @@index([isActive])
  @@index([expiresAt])
  @@map("claim_codes")
}

model IdGenerationLog {
  id          String   @id @default(cuid())
  schoolId    String
  entityType  String
  entityId    String
  generatedId String
  format      IdFormat
  metadata    Json
  createdAt   DateTime @default(now())
  createdBy   String?
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId, entityType])
  @@index([entityId])
  @@index([generatedId])
  @@index([createdAt])
  @@map("id_generation_logs")
}

model TimetableTemplate {
  id             String      @id @default(cuid())
  schoolId       String
  name           String
  description    String?
  gradeLevel     GradeLevel?
  periodsPerWeek Json
  isDefault      Boolean     @default(false)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([gradeLevel])
  @@map("timetable_templates")
}

model TimetablePublish {
  id             String                 @id @default(cuid())
  schoolId       String
  academicYearId String
  publishedAt    DateTime               @default(now())
  publishedBy    String
  status         TimetablePublishStatus @default(DRAFT)
  notifyTeachers Boolean                @default(false)
  notifyClasses  Boolean                @default(false)
  notes          String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@index([schoolId])
  @@index([academicYearId])
  @@index([status])
  @@map("timetable_publishes")
}

model Conversation {
  id            String    @id @default(cuid())
  schoolId      String
  teacherId     String
  parentId      String
  studentId     String?
  lastMessageAt DateTime  @default(now())
  isArchived    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  parent        Parent    @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student       Student?  @relation(fields: [studentId], references: [id])
  teacher       Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([teacherId, parentId])
  @@index([teacherId])
  @@index([parentId])
  @@index([studentId])
  @@index([lastMessageAt(sort: Desc)])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  senderType     SenderType
  content        String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([isRead])
  @@map("messages")
}

model DMConversation {
  id            String          @id @default(cuid())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  lastMessageAt DateTime        @default(now())
  lastMessage   String?
  isGroup       Boolean         @default(false)
  groupName     String?
  groupAvatar   String?
  messages      DirectMessage[]
  participants  DMParticipant[]

  @@index([lastMessageAt(sort: Desc)])
  @@map("dm_conversations")
}

model DMParticipant {
  id             String         @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime       @default(now())
  leftAt         DateTime?
  isAdmin        Boolean        @default(false)
  isMuted        Boolean        @default(false)
  mutedUntil     DateTime?
  lastReadAt     DateTime?
  unreadCount    Int            @default(0)
  conversation   DMConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId, leftAt])
  @@index([conversationId])
  @@map("dm_participants")
}

model DirectMessage {
  id             String          @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  messageType    DMMessageType   @default(TEXT)
  mediaUrl       String?
  mediaType      String?
  replyToId      String?
  isEdited       Boolean         @default(false)
  editedAt       DateTime?
  isDeleted      Boolean         @default(false)
  deletedAt      DateTime?
  createdAt      DateTime        @default(now())
  conversation   DMConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  replyTo        DirectMessage?  @relation("MessageReplies", fields: [replyToId], references: [id])
  replies        DirectMessage[] @relation("MessageReplies")
  sender         User            @relation("DMSender", fields: [senderId], references: [id], onDelete: Cascade)
  readReceipts   DMReadReceipt[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([replyToId])
  @@map("direct_messages")
}

model DMReadReceipt {
  id        String        @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime      @default(now())
  message   DirectMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@map("dm_read_receipts")
}

model StudyClub {
  id                 String             @id @default(cuid())
  name               String
  description        String?
  clubType           StudyClubType      @default(CASUAL_STUDY_GROUP)
  category           String?
  coverImage         String?
  creatorId          String
  schoolId           String?
  maxMembers         Int?
  isActive           Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  capacity           Int?
  color              String?            @default("#FFA500")
  enableAnalytics    Boolean            @default(false)
  enableAssignments  Boolean            @default(false)
  enableAttendance   Boolean            @default(false)
  enableAwards       Boolean            @default(false)
  enableGrading      Boolean            @default(false)
  enableParentAccess Boolean            @default(false)
  enableReports      Boolean            @default(false)
  enableSubjects     Boolean            @default(false)
  enableTranscripts  Boolean            @default(false)
  endDate            DateTime?
  gradingScale       String?
  language           String?            @default("en")
  level              String?
  mode               ClubMode           @default(PUBLIC)
  objectives         String?
  passingGrade       Float?
  prerequisites      String?
  startDate          DateTime?
  subject            String?
  syllabus           String?
  tags               String[]
  term               String?
  announcements      ClubAnnouncement[]
  assignments        ClubAssignment[]
  attendance         ClubAttendance[]
  awards             ClubAward[]
  grades             ClubGrade[]
  materials          ClubMaterial[]
  members            ClubMember[]
  reports            ClubReport[]
  schedules          ClubSchedule[]
  sessions           ClubSession[]
  subjects           ClubSubject[]
  posts              Post[]             @relation("ClubPosts")
  creator            User               @relation("ClubCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  school             School?            @relation(fields: [schoolId], references: [id])

  @@index([creatorId])
  @@index([clubType])
  @@index([mode])
  @@index([category])
  @@index([schoolId])
  @@index([isActive])
  @@map("study_clubs")
}

model ClubMember {
  id               String                     @id @default(cuid())
  clubId           String
  userId           String
  role             ClubMemberRole             @default(STUDENT)
  studentNumber    String?
  enrollmentDate   DateTime                   @default(now())
  isActive         Boolean                    @default(true)
  withdrawnAt      DateTime?
  withdrawalReason String?
  invitedBy        String?
  joinedAt         DateTime                   @default(now())
  assignments      ClubAssignmentSubmission[]
  attendance       ClubAttendance[]
  awards           ClubAward[]
  grades           ClubGrade[]
  club             StudyClub                  @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user             User                       @relation("ClubMemberships", fields: [userId], references: [id], onDelete: Cascade)
  reports          ClubReport[]

  @@unique([clubId, userId])
  @@index([userId])
  @@index([clubId])
  @@index([clubId, role])
  @@map("club_members")
}

model ClubSubject {
  id           String           @id @default(cuid())
  clubId       String
  name         String
  code         String?
  description  String?
  credits      Float?
  weeklyHours  Float?
  weight       Float            @default(1.0)
  instructorId String?
  maxScore     Int              @default(100)
  passingScore Float?
  order        Int?
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  assignments  ClubAssignment[]
  grades       ClubGrade[]
  club         StudyClub        @relation(fields: [clubId], references: [id], onDelete: Cascade)
  instructor   User?            @relation("ClubInstructor", fields: [instructorId], references: [id])

  @@unique([clubId, code])
  @@index([clubId])
  @@index([instructorId])
  @@map("club_subjects")
}

model ClubGrade {
  id             String         @id @default(cuid())
  clubId         String
  memberId       String
  subjectId      String
  assessmentType AssessmentType
  assessmentName String
  score          Float
  maxScore       Float
  percentage     Float?
  weightedScore  Float?
  term           String?
  gradedDate     DateTime       @default(now())
  remarks        String?
  gradedById     String
  isConfirmed    Boolean        @default(false)
  confirmedAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  club           StudyClub      @relation(fields: [clubId], references: [id], onDelete: Cascade)
  gradedBy       User           @relation("ClubGrader", fields: [gradedById], references: [id])
  member         ClubMember     @relation(fields: [memberId], references: [id], onDelete: Cascade)
  subject        ClubSubject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([memberId, subjectId, assessmentType, assessmentName])
  @@index([clubId])
  @@index([memberId])
  @@index([subjectId])
  @@index([gradedById])
  @@map("club_grades")
}

model ClubSession {
  id                 String           @id @default(cuid())
  clubId             String
  title              String
  description        String?
  sessionDate        DateTime
  startTime          String
  endTime            String
  duration           Int
  location           String?
  meetingUrl         String?
  topics             String[]
  materials          String[]
  attendanceRequired Boolean          @default(true)
  createdById        String
  createdAt          DateTime         @default(now())
  attendances        ClubAttendance[]
  club               StudyClub        @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdBy          User             @relation("ClubSessionCreator", fields: [createdById], references: [id])

  @@index([clubId])
  @@index([sessionDate])
  @@index([createdById])
  @@map("club_sessions")
}

model ClubAttendance {
  id          String           @id @default(cuid())
  sessionId   String
  memberId    String
  status      AttendanceStatus @default(PRESENT)
  arrivedAt   DateTime?
  notes       String?
  markedById  String?
  markedAt    DateTime         @default(now())
  studyClubId String?
  markedBy    User?            @relation("ClubAttendanceMarker", fields: [markedById], references: [id])
  member      ClubMember       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  session     ClubSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  StudyClub   StudyClub?       @relation(fields: [studyClubId], references: [id])

  @@unique([sessionId, memberId])
  @@index([memberId])
  @@index([sessionId])
  @@index([markedById])
  @@map("club_attendance")
}

model ClubAssignment {
  id                  String                     @id @default(cuid())
  clubId              String
  subjectId           String?
  title               String
  description         String
  instructions        String?
  type                AssessmentType             @default(HOMEWORK)
  maxPoints           Int
  weight              Float                      @default(1.0)
  publishedAt         DateTime?
  dueDate             DateTime
  lateDeadline        DateTime?
  allowLateSubmission Boolean                    @default(false)
  latePenalty         Float?
  attachments         Json?
  status              AssignmentStatus           @default(DRAFT)
  autoGrade           Boolean                    @default(false)
  requireFile         Boolean                    @default(true)
  maxFileSize         Int?
  allowedFileTypes    String[]
  createdById         String
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  submissions         ClubAssignmentSubmission[]
  club                StudyClub                  @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdBy           User                       @relation("ClubAssignmentCreator", fields: [createdById], references: [id])
  subject             ClubSubject?               @relation(fields: [subjectId], references: [id])

  @@index([clubId])
  @@index([subjectId])
  @@index([dueDate])
  @@index([createdById])
  @@map("club_assignments")
}

model ClubAssignmentSubmission {
  id                   String                     @id @default(cuid())
  assignmentId         String
  memberId             String
  content              String?
  attachments          Json?
  submittedAt          DateTime                   @default(now())
  isLate               Boolean                    @default(false)
  status               SubmissionStatus           @default(SUBMITTED)
  score                Float?
  feedback             String?
  gradedAt             DateTime?
  gradedById           String?
  attemptNumber        Int                        @default(1)
  previousSubmissionId String?
  assignment           ClubAssignment             @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  gradedBy             User?                      @relation("ClubSubmissionGrader", fields: [gradedById], references: [id])
  member               ClubMember                 @relation(fields: [memberId], references: [id], onDelete: Cascade)
  previousSubmission   ClubAssignmentSubmission?  @relation("Resubmissions", fields: [previousSubmissionId], references: [id])
  resubmissions        ClubAssignmentSubmission[] @relation("Resubmissions")

  @@unique([assignmentId, memberId, attemptNumber])
  @@index([memberId])
  @@index([assignmentId])
  @@index([gradedById])
  @@map("club_assignment_submissions")
}

model ClubReport {
  id                  String     @id @default(cuid())
  clubId              String
  memberId            String
  reportType          String
  term                String?
  overallGrade        Float?
  overallPercentage   Float?
  letterGrade         String?
  gpa                 Float?
  totalSessions       Int?
  sessionsPresent     Int?
  attendanceRate      Float?
  strengths           String?
  areasForImprovement String?
  teacherComments     String?
  recommendations     String?
  pdfUrl              String?
  generatedById       String
  generatedAt         DateTime   @default(now())
  club                StudyClub  @relation(fields: [clubId], references: [id], onDelete: Cascade)
  generatedBy         User       @relation("ClubReportGenerator", fields: [generatedById], references: [id])
  member              ClubMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@index([memberId])
  @@index([generatedById])
  @@map("club_reports")
}

model ClubAward {
  id                String     @id @default(cuid())
  clubId            String
  memberId          String
  title             String
  type              AwardType
  description       String?
  criteria          String?
  certificateUrl    String?
  certificateDesign String?
  awardedById       String
  awardedAt         DateTime   @default(now())
  awardedBy         User       @relation("ClubAwardGiver", fields: [awardedById], references: [id])
  club              StudyClub  @relation(fields: [clubId], references: [id], onDelete: Cascade)
  member            ClubMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@index([memberId])
  @@index([awardedById])
  @@map("club_awards")
}

model ClubMaterial {
  id                 String       @id @default(cuid())
  clubId             String
  title              String
  description        String?
  type               MaterialType
  url                String
  fileName           String?
  fileSize           Int?
  mimeType           String?
  category           String?
  week               Int?
  order              Int?
  tags               String[]
  isPublic           Boolean      @default(false)
  requiresEnrollment Boolean      @default(true)
  viewCount          Int          @default(0)
  downloadCount      Int          @default(0)
  uploadedById       String
  uploadedAt         DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  club               StudyClub    @relation(fields: [clubId], references: [id], onDelete: Cascade)
  uploadedBy         User         @relation("ClubMaterialUploader", fields: [uploadedById], references: [id])

  @@index([clubId])
  @@index([category])
  @@index([uploadedById])
  @@map("club_materials")
}

model ClubSchedule {
  id             String    @id @default(cuid())
  clubId         String
  dayOfWeek      DayOfWeek
  startTime      String
  endTime        String
  location       String?
  meetingUrl     String?
  isRecurring    Boolean   @default(true)
  effectiveFrom  DateTime?
  effectiveUntil DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  club           StudyClub @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@index([clubId])
  @@index([dayOfWeek])
  @@map("club_schedules")
}

model ClubAnnouncement {
  id          String           @id @default(cuid())
  clubId      String
  title       String
  content     String
  isPinned    Boolean          @default(false)
  priority    String?
  targetRoles ClubMemberRole[]
  createdById String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  club        StudyClub        @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdBy   User             @relation("ClubAnnouncementCreator", fields: [createdById], references: [id])

  @@index([clubId])
  @@index([createdAt])
  @@index([createdById])
  @@map("club_announcements")
}

model Event {
  id           String            @id @default(cuid())
  title        String
  description  String?
  startDate    DateTime
  endDate      DateTime?
  allDay       Boolean           @default(false)
  location     String?
  virtualLink  String?
  coverImage   String?
  eventType    CalendarEventType @default(GENERAL)
  privacy      EventPrivacy      @default(PUBLIC)
  maxAttendees Int?
  creatorId    String
  schoolId     String?
  studyClubId  String?
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  attendees    EventAttendee[]
  creator      User              @relation("EventCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([schoolId])
  @@index([studyClubId])
  @@index([startDate])
  @@index([eventType])
  @@map("events")
}

model EventAttendee {
  id          String     @id @default(cuid())
  eventId     String
  userId      String
  status      RSVPStatus @default(PENDING)
  respondedAt DateTime?
  createdAt   DateTime   @default(now())
  event       Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@map("event_attendees")
}

model Course {
  id            String               @id @default(cuid())
  title         String
  description   String
  thumbnail     String?
  category      String
  level         CourseLevel          @default(BEGINNER)
  duration      Int                  @default(0)
  lessonsCount  Int                  @default(0)
  price         Float                @default(0)
  isFree        Boolean              @default(true)
  isFeatured    Boolean              @default(false)
  isPublished   Boolean              @default(false)
  instructorId  String
  tags          String[]
  rating        Float                @default(0)
  reviewsCount  Int                  @default(0)
  enrolledCount Int                  @default(0)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  reviews       CourseReview[]
  instructor    User                 @relation("CourseInstructor", fields: [instructorId], references: [id])
  enrollments   Enrollment[]
  pathCourses   LearningPathCourse[]
  lessons       Lesson[]
  UserDeadline  UserDeadline[]

  @@index([category])
  @@index([level])
  @@index([isFeatured])
  @@index([isPublished])
  @@index([instructorId])
  @@map("courses")
}

model Lesson {
  id          String           @id @default(cuid())
  courseId    String
  title       String
  description String?
  content     String?
  videoUrl    String?
  duration    Int              @default(0)
  order       Int
  isFree      Boolean          @default(false)
  isPublished Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  progress    LessonProgress[]
  resources   LessonResource[]
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([order])
  @@map("lessons")
}

model LessonResource {
  id        String       @id @default(cuid())
  lessonId  String
  title     String
  type      ResourceType @default(FILE)
  url       String
  size      Int?
  createdAt DateTime     @default(now())
  lesson    Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@map("lesson_resources")
}

model Enrollment {
  id             String    @id @default(cuid())
  userId         String
  courseId       String
  progress       Float     @default(0)
  completedAt    DateTime?
  certificateUrl String?
  enrolledAt     DateTime  @default(now())
  lastAccessedAt DateTime  @default(now())
  course         Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("enrollments")
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  watchTime   Int       @default(0)
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("lesson_progress")
}

model CourseReview {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  rating    Int
  comment   String?
  isHelpful Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@map("course_reviews")
}

model LearningPath {
  id            String               @id @default(cuid())
  title         String
  description   String
  thumbnail     String?
  level         String               @default("BEGINNER")
  isFeatured    Boolean              @default(false)
  isPublished   Boolean              @default(false)
  creatorId     String
  totalDuration Int                  @default(0)
  coursesCount  Int                  @default(0)
  enrolledCount Int                  @default(0)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  courses       LearningPathCourse[]
  creator       User                 @relation("PathCreator", fields: [creatorId], references: [id])
  enrollments   PathEnrollment[]

  @@index([isFeatured])
  @@index([isPublished])
  @@map("learning_paths")
}

model LearningPathCourse {
  id       String       @id @default(cuid())
  pathId   String
  courseId String
  order    Int
  course   Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  path     LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)

  @@unique([pathId, courseId])
  @@index([pathId])
  @@map("learning_path_courses")
}

model PathEnrollment {
  id         String       @id @default(cuid())
  userId     String
  pathId     String
  progress   Float        @default(0)
  enrolledAt DateTime     @default(now())
  path       LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)

  @@unique([userId, pathId])
  @@index([userId])
  @@map("path_enrollments")
}

model Story {
  id              String          @id @default(cuid())
  authorId        String
  type            StoryType       @default(TEXT)
  mediaUrl        String?
  thumbnailUrl    String?
  text            String?
  backgroundColor String?
  textColor       String?
  fontStyle       String?
  duration        Int             @default(5)
  viewCount       Int             @default(0)
  isActive        Boolean         @default(true)
  expiresAt       DateTime
  createdAt       DateTime        @default(now())
  author          User            @relation("UserStories", fields: [authorId], references: [id], onDelete: Cascade)
  reactions       StoryReaction[]
  views           StoryView[]

  @@index([authorId])
  @@index([expiresAt])
  @@index([isActive])
  @@map("stories")
}

model StoryView {
  id       String   @id @default(cuid())
  storyId  String
  viewerId String
  viewedAt DateTime @default(now())
  story    Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, viewerId])
  @@index([storyId])
  @@index([viewerId])
  @@map("story_views")
}

model StoryReaction {
  id        String   @id @default(cuid())
  storyId   String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId])
  @@index([storyId])
  @@map("story_reactions")
}

model UserStats {
  id             String                @id @default(cuid())
  userId         String                @unique
  xp             Int                   @default(0)
  level          Int                   @default(1)
  totalQuizzes   Int                   @default(0)
  totalPoints    Int                   @default(0)
  correctAnswers Int                   @default(0)
  totalAnswers   Int                   @default(0)
  winStreak      Int                   @default(0)
  bestStreak     Int                   @default(0)
  liveQuizWins   Int                   @default(0)
  liveQuizTotal  Int                   @default(0)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  streaks        LearningStreak[]
  attempts       QuizAttemptRecord[]
  achievements   UserGameAchievement[]
  user           User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([xp])
  @@index([level])
  @@index([userId])
}

model QuizAttemptRecord {
  id          String     @id @default(cuid())
  userId      String
  quizId      String
  score       Int
  totalPoints Int
  accuracy    Float
  timeSpent   Int
  rank        Int?
  xpEarned    Int
  type        String
  sessionCode String?
  createdAt   DateTime   @default(now())
  userStatsId String?
  quiz        Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userStats   UserStats? @relation(fields: [userStatsId], references: [id])

  @@index([userId])
  @@index([quizId])
  @@index([userStatsId])
  @@index([createdAt])
}

model QuizChallenge {
  id              String                 @id @default(cuid())
  challengerId    String
  opponentId      String
  quizId          String
  status          String
  challengerScore Int?
  opponentScore   Int?
  winnerId        String?
  createdAt       DateTime               @default(now())
  expiresAt       DateTime
  completedAt     DateTime?
  participants    ChallengeParticipant[]
  challenger      User                   @relation("ChallengerChallenges", fields: [challengerId], references: [id], onDelete: Cascade)
  opponent        User                   @relation("OpponentChallenges", fields: [opponentId], references: [id], onDelete: Cascade)
  quiz            Quiz                   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([challengerId])
  @@index([opponentId])
  @@index([status])
}

model ChallengeParticipant {
  id          String        @id @default(cuid())
  challengeId String
  userId      String
  score       Int?
  completedAt DateTime?
  challenge   QuizChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@index([userId])
}

model GameAchievement {
  id               String                @id @default(cuid())
  key              String                @unique
  name             String
  description      String
  icon             String
  xpReward         Int
  category         String
  tier             String
  createdAt        DateTime              @default(now())
  userAchievements UserGameAchievement[]
}

model UserGameAchievement {
  id            String          @id @default(cuid())
  userId        String
  achievementId String
  progress      Int             @default(0)
  completed     Boolean         @default(false)
  unlockedAt    DateTime?
  createdAt     DateTime        @default(now())
  userStatsId   String?
  achievement   GameAchievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  UserStats     UserStats?      @relation(fields: [userStatsId], references: [id])

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([completed])
}

model LearningStreak {
  id            String     @id @default(cuid())
  userId        String     @unique
  currentStreak Int        @default(0)
  longestStreak Int        @default(0)
  lastQuizDate  DateTime?
  freezesUsed   Int        @default(0)
  freezesTotal  Int        @default(3)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  userStatsId   String?
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  UserStats     UserStats? @relation(fields: [userStatsId], references: [id])

  @@index([userId])
  @@index([currentStreak])
}

model WeeklyLeaderboard {
  id        String   @id @default(cuid())
  userId    String
  weekStart DateTime
  weekEnd   DateTime
  xpEarned  Int
  rank      Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStart])
  @@index([weekStart])
  @@index([rank])
}

model SocialAccount {
  id             String         @id @default(cuid())
  userId         String
  provider       SocialProvider
  providerUserId String
  email          String?
  displayName    String?
  avatarUrl      String?
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  rawProfile     Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@unique([provider, userId])
  @@index([userId])
  @@map("social_accounts")
}

model TwoFactorSecret {
  id          String    @id @default(cuid())
  userId      String    @unique
  secret      String
  isEnabled   Boolean   @default(false)
  backupCodes String[]
  verifiedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_secrets")
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String?
  phone     String?
  ipAddress String
  userAgent String?
  success   Boolean
  reason    String?
  createdAt DateTime @default(now())

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@map("login_attempts")
}

model UserAcademicProfile {
  userId       String   @id
  currentLevel Decimal  @default(2.5) @db.Decimal(3, 2)
  weakTopics   String[]
  strongTopics String[]
  lastUpdated  DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_academic_profiles")
}

model GamificationAchievement {
  id           String                    @id @default(cuid())
  category     AchievementCategory
  tier         AchievementTier
  name         String
  description  String
  icon         String
  criteria     Json
  xpReward     Int
  coinReward   Int
  requiredId   String?
  isActive     Boolean                   @default(true)
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  userProgress UserAchievementProgress[]

  @@map("gamification_achievements")
}

model UserAchievementProgress {
  id            String                  @id @default(cuid())
  userId        String
  achievementId String
  progress      Int                     @default(0)
  isUnlocked    Boolean                 @default(false)
  unlockedAt    DateTime?
  lastUpdated   DateTime                @default(now())
  achievement   GamificationAchievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievement_progress")
}

model ChallengeTemplate {
  id          String              @id @default(cuid())
  type        ChallengeType
  difficulty  ChallengeDifficulty
  name        String
  description String
  targetValue Int
  xpReward    Int
  coinReward  Int
  criteria    Json
  weight      Int                 @default(1)
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  challenges  Challenge[]

  @@map("challenge_templates")
}

model Challenge {
  id          String            @id @default(cuid())
  userId      String
  templateId  String
  status      ChallengeStatus   @default(ACTIVE)
  progress    Int               @default(0)
  expiresAt   DateTime
  createdAt   DateTime          @default(now())
  completedAt DateTime?
  template    ChallengeTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("challenges")
}

model VirtualCurrency {
  userId    String   @id
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("virtual_currency")
}

model VirtualCurrencyTransaction {
  id        String          @id @default(cuid())
  userId    String
  amount    Int
  type      TransactionType
  source    String
  sourceId  String?
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("virtual_currency_transactions")
}

model Unlockable {
  id                    String           @id @default(cuid())
  type                  UnlockableType
  name                  String
  description           String
  cost                  Int
  metadata              Json?
  requiredAchievementId String?
  isActive              Boolean          @default(true)
  createdAt             DateTime         @default(now())
  owners                UserUnlockable[]

  @@map("unlockables")
}

model UserUnlockable {
  id           String     @id @default(cuid())
  userId       String
  unlockableId String
  isEquipped   Boolean    @default(false)
  unlockedAt   DateTime   @default(now())
  unlockable   Unlockable @relation(fields: [unlockableId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, unlockableId])
  @@index([userId])
  @@map("user_unlockables")
}

model TeamChallenge {
  id           String                     @id @default(cuid())
  name         String
  description  String
  targetValue  Int
  currentValue Int                        @default(0)
  status       TeamChallengeStatus        @default(PENDING)
  deadline     DateTime
  xpReward     Int
  coinReward   Int
  createdAt    DateTime                   @default(now())
  completedAt  DateTime?
  participants TeamChallengeParticipant[]

  @@map("team_challenges")
}

model TeamChallengeParticipant {
  id              String        @id @default(cuid())
  teamChallengeId String
  userId          String
  contribution    Int           @default(0)
  joinedAt        DateTime      @default(now())
  teamChallenge   TeamChallenge @relation(fields: [teamChallengeId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamChallengeId, userId])
  @@index([userId])
  @@map("team_challenge_participants")
}

model Leaderboard {
  id          String              @id @default(cuid())
  category    LeaderboardCategory
  scope       LeaderboardScope
  period      LeaderboardPeriod
  periodStart DateTime
  entries     Json
  createdAt   DateTime            @default(now())

  @@index([category, scope, period])
  @@map("leaderboards")
}

model AttendanceStreak {
  userId        String    @id
  currentStreak Int       @default(0)
  longestStreak Int       @default(0)
  lastPresentAt DateTime?
  graceActive   Boolean   @default(false)
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("attendance_streaks")
}

model MilestoneEvent {
  id          String        @id @default(cuid())
  userId      String
  type        MilestoneType
  title       String
  description String
  metadata    Json?
  isViewed    Boolean       @default(false)
  createdAt   DateTime      @default(now())
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isViewed])
  @@map("milestone_events")
}

model UserDeadline {
  id            String   @id @default(cuid())
  userId        String
  title         String
  deadlineDate  DateTime
  relatedTopics String[]
  courseId      String?
  priority      String   @default("MEDIUM")
  createdAt     DateTime @default(now())
  course        Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deadlineDate])
  @@map("user_deadlines")
}

model SchoolLocation {
  id                String              @id @default(cuid())
  schoolId          String
  name              String
  latitude          Float
  longitude         Float
  radius            Float               @default(50)
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  school            School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacherAttendance TeacherAttendance[]

  @@index([schoolId, isActive])
  @@map("school_locations")
}

model TeacherAttendance {
  id         String         @id @default(cuid())
  teacherId  String
  locationId String
  date       DateTime       @db.Date
  timeIn     DateTime
  timeOut    DateTime?
  status     String         @default("PRESENT")
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  location   SchoolLocation @relation(fields: [locationId], references: [id])
  teacher    Teacher        @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, date])
  @@index([teacherId, date])
  @@index([locationId, date])
  @@map("teacher_attendance")
}

model PlatformAuditLog {
  id           String   @id @default(cuid())
  actorId      String
  action       String
  resourceType String
  resourceId   String?
  details      Json?
  ipAddress    String?
  createdAt    DateTime @default(now())
  actor        User     @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("platform_audit_logs")
}

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  description String?
  enabled     Boolean  @default(false)
  schoolId    String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  school      School?  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([key])
  @@index([schoolId])
  @@map("feature_flags")
}

model PlatformAnnouncement {
  id        String                       @id @default(cuid())
  title     String
  content   String
  priority  PlatformAnnouncementPriority @default(INFO)
  isActive  Boolean                      @default(true)
  startAt   DateTime?
  endAt     DateTime?
  createdAt DateTime                     @default(now())
  updatedAt DateTime                     @updatedAt

  @@index([isActive, startAt, endAt])
  @@map("platform_announcements")
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SchoolType {
  PRIMARY_SCHOOL
  MIDDLE_SCHOOL
  HIGH_SCHOOL
  COMPLETE_SCHOOL
  INTERNATIONAL
}

enum AcademicYearStatus {
  PLANNING
  ACTIVE
  ENDED
  ARCHIVED
}

enum PromotionType {
  AUTOMATIC
  MANUAL
  REPEAT
  NEW_ADMISSION
  TRANSFER_IN
  TRANSFER_OUT
}

enum SubscriptionTier {
  FREE_TRIAL_1M
  FREE_TRIAL_3M
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum AttendanceSession {
  MORNING
  AFTERNOON
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  PERMISSION
  LATE
  EXCUSED
  MEDICAL_LEAVE
}

enum DegreeLevel {
  CERTIFICATE
  ASSOCIATE
  BACHELOR
  MASTER
  DOCTORATE
  OTHER
}

enum Gender {
  MALE
  FEMALE
}

enum TeacherRole {
  TEACHER
  INSTRUCTOR
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  PARENT
  STAFF
}

enum WorkingLevel {
  FRAMEWORK_A
  FRAMEWORK_B
  FRAMEWORK_C
  CONTRACT
  PROBATION
}

enum StudentRole {
  GENERAL
  CLASS_LEADER
  VICE_LEADER_1
  VICE_LEADER_2
}

enum ParentRelationship {
  FATHER
  MOTHER
  GUARDIAN
  STEP_FATHER
  STEP_MOTHER
  GRANDPARENT
  OTHER
}

enum ProfileVisibility {
  PUBLIC
  SCHOOL
  CLASS
  PRIVATE
}

enum PostType {
  ARTICLE
  COURSE
  QUIZ
  QUESTION
  EXAM
  ANNOUNCEMENT
  ASSIGNMENT
  POLL
  RESOURCE
  PROJECT
  TUTORIAL
  RESEARCH
  ACHIEVEMENT
  REFLECTION
  COLLABORATION
  CLUB_CREATED
  EVENT_CREATED
}

enum PostVisibility {
  PUBLIC
  SCHOOL
  CLASS
  PRIVATE
}

enum NotificationType {
  LIKE
  COMMENT
  REPLY
  FOLLOW
  MENTION
  ANNOUNCEMENT
  GRADE_POSTED
  ATTENDANCE_MARKED
  SKILL_ENDORSED
  RECOMMENDATION_RECEIVED
  PROJECT_LIKED
  ACHIEVEMENT_EARNED
  COURSE_ENROLL
  ASSIGNMENT_DUE
  POLL_RESULT
  SHARE
}

enum ReactionType {
  LIKE
  LOVE
  HELPFUL
  INSIGHTFUL
}

enum ReportReason {
  SPAM
  HARASSMENT
  INAPPROPRIATE
  MISINFORMATION
  VIOLENCE
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  APPROVED
  REMOVED
}

enum SkillCategory {
  PROGRAMMING
  LANGUAGES
  MATHEMATICS
  SCIENCE
  HUMANITIES
  ARTS
  SPORTS
  TEACHING
  LEADERSHIP
  COMMUNICATION
  TECHNICAL
  BUSINESS
  OTHER
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum ExperienceType {
  WORK
  TEACHING
  VOLUNTEER
  INTERNSHIP
  RESEARCH
  LEADERSHIP
  EXTRACURRICULAR
}

enum ProjectCategory {
  SOFTWARE
  RESEARCH
  DESIGN
  WRITING
  SCIENCE
  MATHEMATICS
  ARTS
  ENGINEERING
  BUSINESS
  SOCIAL_IMPACT
  OTHER
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
  PUBLISHED
}

enum AchievementType {
  COURSE_COMPLETION
  SKILL_MASTERY
  TEACHING_EXCELLENCE
  COMMUNITY_CONTRIBUTION
  LEADERSHIP
  INNOVATION
  COLLABORATION
  CONSISTENCY_STREAK
  TOP_PERFORMER
  MILESTONE
  COMPETITION_WIN
  PUBLICATION
  CERTIFICATION
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum RecommendationRelation {
  TEACHER
  CLASSMATE
  MENTOR
  COLLEAGUE
  SUPERVISOR
  OTHER
}

enum EventType {
  SCHOOL_DAY
  HOLIDAY
  VACATION
  EXAM_PERIOD
  REGISTRATION
  ORIENTATION
  PARENT_MEETING
  SPORTS_DAY
  CULTURAL_EVENT
  SPECIAL_EVENT
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum GradeLevel {
  PRIMARY
  SECONDARY
  HIGH_SCHOOL
}

enum TimetablePublishStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SenderType {
  TEACHER
  PARENT
}

enum DMMessageType {
  TEXT
  IMAGE
  FILE
  VOICE
  VIDEO
  STICKER
  SYSTEM
}

enum AssessmentType {
  HOMEWORK
  QUIZ
  MIDTERM
  FINAL_EXAM
  PROJECT
  PRESENTATION
  PARTICIPATION
  LAB_WORK
  OTHER
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum SubmissionStatus {
  NOT_SUBMITTED
  SUBMITTED
  LATE
  GRADED
  RESUBMISSION_REQUIRED
}

enum AwardType {
  CERTIFICATE_OF_COMPLETION
  HONOR_ROLL
  PERFECT_ATTENDANCE
  MOST_IMPROVED
  BEST_PROJECT
  EXCELLENCE_AWARD
  CUSTOM
}

enum MaterialType {
  DOCUMENT
  VIDEO
  LINK
  IMAGE
  AUDIO
  PRESENTATION
  CODE
  QUIZ
}

enum StudyClubType {
  CASUAL_STUDY_GROUP
  STRUCTURED_CLASS
  PROJECT_GROUP
  EXAM_PREP
}

enum ClubMode {
  PUBLIC
  INVITE_ONLY
  APPROVAL_REQUIRED
}

enum ClubMemberRole {
  OWNER
  INSTRUCTOR
  TEACHING_ASSISTANT
  STUDENT
  OBSERVER
}

enum CalendarEventType {
  GENERAL
  ACADEMIC
  SPORTS
  CULTURAL
  CLUB
  WORKSHOP
  MEETING
  HOLIDAY
  DEADLINE
  COMPETITION
}

enum EventPrivacy {
  PUBLIC
  SCHOOL
  CLUB
  INVITE_ONLY
}

enum RSVPStatus {
  PENDING
  GOING
  MAYBE
  NOT_GOING
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ALL_LEVELS
}

enum ResourceType {
  FILE
  LINK
  PDF
  VIDEO
  AUDIO
}

enum StoryType {
  TEXT
  IMAGE
  VIDEO
}

enum IdFormat {
  STRUCTURED
  SIMPLIFIED
  HYBRID
}

enum ClaimCodeType {
  STUDENT
  TEACHER
  STAFF
  PARENT
}

enum AccountType {
  SOCIAL_ONLY
  SCHOOL_ONLY
  HYBRID
}

enum SocialProvider {
  GOOGLE
  APPLE
  FACEBOOK
  LINKEDIN
}

enum AchievementCategory {
  ACADEMIC
  SOCIAL
  CHALLENGE
  ATTENDANCE
  COMPOSITE
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum ChallengeType {
  DAILY
  WEEKLY
  SPECIAL
  TEAM
}

enum ChallengeDifficulty {
  EASY
  MEDIUM
  HARD
}

enum ChallengeStatus {
  ACTIVE
  COMPLETED
  EXPIRED
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum UnlockableType {
  AVATAR
  THEME
  BADGE_FRAME
  PROFILE_EFFECT
}

enum TeamChallengeStatus {
  PENDING
  ACTIVE
  COMPLETED
  EXPIRED
}

enum LeaderboardCategory {
  TOTAL_XP
  ACADEMIC_PERFORMANCE
  SOCIAL_ENGAGEMENT
  ATTENDANCE_RATE
  CHALLENGE_COMPLETION
}

enum LeaderboardScope {
  SCHOOL_WIDE
  GRADE_LEVEL
  CLASS_SPECIFIC
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum MilestoneType {
  LEVEL_UP
  ACHIEVEMENT_UNLOCK
  STREAK_MILESTONE
  CHALLENGE_COMPLETION
  LEADERBOARD_TOP_10
}

enum PlatformAnnouncementPriority {
  INFO
  WARNING
  URGENT
}
